const CONFIG={SSE_MAX_RECONNECTS:5,SSE_RECONNECT_DELAYS:[1e3,2e3,5e3,1e4,3e4],TOAST_DUPLICATE_CHECK_TIME:3e3,TOAST_AUTO_HIDE_DELAY:3e3,RATE_LIMIT_DELAY:500,PAGE_SIZE_MOBILE:6,PAGE_SIZE_DESKTOP:9,MIN_ITEMS_PAGINATION_MOBILE:5,MIN_ITEMS_PAGINATION_DESKTOP:9,MIN_SERVERS_PAGINATION_MOBILE:3,MIN_SERVERS_PAGINATION_DESKTOP:9,POLLING_INTERVAL:5e3};let currentUser=localStorage.getItem("swsm_user"),currentServerId=localStorage.getItem("swsm_current_server_id"),currentServerData=null,allServers=[],serversCurrentPage=1,serversTotalPages=1,allServices=[],currentPage=1,totalPages=1,serviceEventsSource=null,servicePollingInterval=null,sseReconnectAttempts=0,sseConnectionStatus="closed";const REQUEST_RATE_LIMIT={};let cachedPageSize=null,lastWindowWidth=window.innerWidth,toastHistory=[];window._sessionExpiredNotified=!1;const loginPage=document.getElementById("loginPage"),mainApp=document.getElementById("mainApp"),loadingSpinner=document.querySelector(".loading-spinner"),currentUserSpan=document.getElementById("currentUser"),serversListView=document.getElementById("serversListView"),serverDetailView=document.getElementById("serverDetailView"),serversList=document.getElementById("serversList"),servicesList=document.getElementById("servicesList");function debounce(r,t=500){let s;return function(...e){s&&clearTimeout(s),s=setTimeout(()=>{r.apply(this,e),s=null},t)}}function canPerformAction(e){var r=Date.now();return r-(REQUEST_RATE_LIMIT[e]||0)<CONFIG.RATE_LIMIT_DELAY?(console.warn(`Действие '${e}' ограничено по времени`),!1):(REQUEST_RATE_LIMIT[e]=r,!0)}function isMobileDevice(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)}function getPageSize(){return null!==cachedPageSize&&window.innerWidth===lastWindowWidth||(lastWindowWidth=window.innerWidth,cachedPageSize=window.innerWidth<768?CONFIG.PAGE_SIZE_MOBILE:CONFIG.PAGE_SIZE_DESKTOP),cachedPageSize}function getMinItemsForPagination(e){var r=window.innerWidth<768;return"services"===e?r?CONFIG.MIN_ITEMS_PAGINATION_MOBILE:CONFIG.MIN_ITEMS_PAGINATION_DESKTOP:"servers"===e?r?CONFIG.MIN_SERVERS_PAGINATION_MOBILE:CONFIG.MIN_SERVERS_PAGINATION_DESKTOP:0}function showToast(e,r,t="success"){const s=e+`|${r}|`+t,n=Date.now();if(toastHistory.find(e=>e.id===s&&n-e.time<CONFIG.TOAST_DUPLICATE_CHECK_TIME))console.warn("[Toast] Дублирование предотвращено:",s);else{toastHistory.push({id:s,time:n}),toastHistory=(toastHistory=50<toastHistory.length?toastHistory.slice(-30):toastHistory).filter(e=>n-e.time<1e4);var a=document.querySelector(".toast-container");const i=document.getElementById("toastTemplate").cloneNode(!0),o=(i.id="toast-"+Date.now()+Math.random(),i.querySelector(".toast-title").textContent=e,i.querySelector(".toast-message").textContent=r,"error"===t?i.classList.add("text-bg-danger"):"warning"===t?i.classList.add("text-bg-warning"):i.classList.add("text-bg-success"),a.appendChild(i),new bootstrap.Toast(i,{autohide:!0,delay:CONFIG.TOAST_AUTO_HIDE_DELAY}));o.show(),setTimeout(()=>{o.hide()},3e3),i.addEventListener("click",e=>{e.target.classList.contains("btn-close")||o.hide()}),i.addEventListener("hidden.bs.toast",()=>{i.remove()})}}document.addEventListener("DOMContentLoaded",function(){currentUser?(showMainApp(),currentServerId?showServerDetail(currentServerId=parseInt(currentServerId)):loadServersList()):showLoginPage(),setupEventListeners()}),window.addEventListener("resize",()=>{cachedPageSize=null}),document.addEventListener("visibilitychange",()=>{document.hidden?(serviceEventsSource&&(serviceEventsSource.close(),serviceEventsSource=null,sseConnectionStatus="closed"),stopServicePolling()):currentServerId&&subscribeServiceEvents(currentServerId)});class SessionExpiredError extends Error{constructor(e){super(e),this.name="SessionExpiredError"}}async function apiRequest(r,t={}){r=""+API_BASE+r,t={method:t.method||"GET",headers:{"Content-Type":"application/json",...t.headers},credentials:"include",cache:t.cache||"default",...t};try{var s=await fetch(r,t);if(401===s.status)throw window._sessionExpiredNotified||(window._sessionExpiredNotified=!0,localStorage.removeItem("swsm_user"),localStorage.removeItem("swsm_current_server_id"),currentUser=null,currentServerId=null,currentServerData=null,allServices=[],currentPage=1,allServers=[],serversCurrentPage=1,serviceEventsSource&&(serviceEventsSource.close(),serviceEventsSource=null),stopServicePolling(),showToast("Сессия истекла","Ваша сессия истекла. Пожалуйста, авторизуйтесь снова.","warning"),showLoginPage()),new SessionExpiredError("Session expired");let e;var n=s.headers.get("Content-Type");if(n&&n.includes("application/json"))e=await s.json();else{var a=await s.text();try{e=JSON.parse(a)}catch{e={message:a}}}if(s.ok)return window._sessionExpiredNotified=!1,e;throw new Error(e.message||e.error||"Ошибка HTTP! статус: "+s.status)}catch(e){throw e instanceof SessionExpiredError||e instanceof TypeError&&e.message.includes("fetch")&&showToast("Ошибка","Не удается подключиться к серверу","error"),e}}function subscribeServiceEvents(t){var e;isMobileDevice()?startServicePolling(t):serviceEventsSource&&serviceEventsSource.readyState===EventSource.OPEN?sseConnectionStatus="open":(serviceEventsSource&&(serviceEventsSource.close(),serviceEventsSource=null),e=API_BASE+"/user/broadcasting",serviceEventsSource=new EventSource(e,{withCredentials:!0}),sseConnectionStatus="connecting",serviceEventsSource.onopen=function(){sseConnectionStatus="open",sseReconnectAttempts=0},serviceEventsSource.onmessage=function(e){try{var r=JSON.parse(e.data).filter(e=>e.server_id===t);0<r.length&&updateServicesStatus(r),sseReconnectAttempts=0}catch(e){console.error("Ошибка разбора данных SSE:",e)}},serviceEventsSource.onerror=function(e){console.error("Ошибка SSE:",e),sseConnectionStatus="closed",sseReconnectAttempts>=CONFIG.SSE_MAX_RECONNECTS?startServicePolling(t):(e=CONFIG.SSE_RECONNECT_DELAYS[sseReconnectAttempts]||3e4,sseReconnectAttempts++,setTimeout(()=>{currentServerId&&subscribeServiceEvents(currentServerId)},e))})}function startServicePolling(r){stopServicePolling();let t=0;servicePollingInterval=setInterval(async()=>{if(!document.hidden)if(currentServerId!==r)stopServicePolling();else try{var e=await apiRequest(`/user/servers/${r}/services`);Array.isArray(e)&&(updateServicesStatus(e),t=0)}catch(e){t++,console.error(`Ошибка полинга (${t}/3):`,e),3<=t&&(console.warn("Слишком много ошибок полинга. Остановка полинга."),stopServicePolling())}},CONFIG.POLLING_INTERVAL)}function stopServicePolling(){servicePollingInterval&&(clearInterval(servicePollingInterval),servicePollingInterval=null)}function updateServicesStatus(e){if(isPageVisible&&Array.isArray(e)&&0!==e.length){const s=new Map(e.map(e=>[e.id,e]));allServices.forEach(e=>{var r=s.get(e.id);r&&(e.status=r.status,e.updatedat=r.updatedat)}),document.querySelectorAll(".service-card").forEach(e=>{var r,t=parseInt(e.getAttribute("data-service-id")),t=s.get(t);t&&(r=e.querySelector(".service-status"),e=e.querySelector(".service-updated"),r&&r.textContent!==t.status&&(r.textContent=t.status),e)&&t.updatedat&&(r=new Date(t.updatedat).toLocaleString("ru-RU"),e.textContent!==r)&&(e.textContent=r)})}}async function handleLogin(e){e.preventDefault();var e=document.getElementById("loginUsername").value,r=document.getElementById("loginPassword").value;showLoading();try{var t=await apiRequest("/user/login",{method:"POST",body:JSON.stringify({login:e,password:r})});currentUser=t.login||t.Login,localStorage.setItem("swsm_user",currentUser),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,currentServerData=null,allServices=[],currentPage=1,window._sessionExpiredNotified=!1,showToast("Успех","Авторизация прошла успешно!"),showMainApp(),setTimeout(()=>{showServersList()},100)}catch(e){e instanceof SessionExpiredError||showToast("Ошибка",e.message,"error")}finally{hideLoading()}}async function handleRegister(e){e.preventDefault();var e=document.getElementById("registerUsername").value.trim(),r=document.getElementById("registerPassword").value,t=document.getElementById("registerPasswordConfirm").value,s=document.getElementById("registrationKey").value.trim();if(r!==t)showToast("Ошибка","Пароли не совпадают","error");else if(e.length<4)showToast("Ошибка","Логин должен содержать не менее 4 символов","error");else if(r.length<5)showToast("Ошибка","Пароль должен содержать не менее 5 символов","error");else{showLoading();try{await apiRequest("/user/register",{method:"POST",body:JSON.stringify({login:e,password:r,registration_key:s})}),bootstrap.Modal.getInstance(document.getElementById("registerModal")).hide(),document.getElementById("registerForm").reset(),showToast("Успех","Регистрация прошла успешно! Теперь авторизуйтесь.")}catch(e){showToast("Ошибка",e.message,"error")}finally{hideLoading()}}}function handleLogout(){stopServicePolling(),localStorage.removeItem("swsm_user"),localStorage.removeItem("swsm_current_server_id"),currentUser=null,currentServerId=null,currentServerData=null,allServices=[],currentPage=1,allServers=[],serversCurrentPage=1,window._sessionExpiredNotified=!1,serviceEventsSource&&(serviceEventsSource.close(),serviceEventsSource=null),showLoginPage(),showToast("Информация","Вы вышли из системы")}async function loadServersList(){showLoading();try{var e=await apiRequest("/user/servers");allServers=e||[],serversCurrentPage=1,renderServersCurrentPage()}catch(e){e instanceof SessionExpiredError||showToast("Ошибка","Не удалось загрузить список серверов","error")}finally{hideLoading()}}function renderServersList(e){serversList.innerHTML="",e&&0!==e.length?e.forEach(e=>{var r=document.createElement("div");r.className="col-md-6 col-lg-4",r.innerHTML=`
            <div class="card h-100 shadow-sm service-card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-server me-2"></i>${e.name}
                    </h5>
                    <p class="card-text">
                        <small class="text-muted">
                            <i class="bi bi-geo-alt me-1"></i>${e.address}
                        </small><br>
                        <small class="text-muted">
                            <i class="bi bi-person me-1"></i>${e.username}
                        </small><br>
                        <small class="text-muted">
                            <i class="bi bi-calendar me-1"></i>${new Date(e.created_at).toLocaleDateString("ru-RU")}
                        </small><br>
                        <small class="text-muted">
                            <i class="bi bi-fingerprint me-1"></i>${e.fingerprint}
                        </small>
                    </p>
                </div>
                <div class="card-footer">
                    <button class="btn btn-primary btn-sm w-100" onclick="showServerDetail(${e.id})">
                        <i class="bi bi-list-task me-1"></i>Управление
                    </button>
                </div>
            </div>
        `,serversList.appendChild(r)}):serversList.innerHTML=`
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle me-2"></i>
                    Серверы не добавлены. Нажмите "Добавить сервер" для начала работы.
                </div>
            </div>
        `}async function handleAddServer(e){if(e.preventDefault(),canPerformAction("addServer")){var e=document.getElementById("serverName").value,r=document.getElementById("serverAddress").value,t=document.getElementById("serverUsername").value,s=document.getElementById("serverPassword").value;showLoading();try{await apiRequest("/user/servers",{method:"POST",body:JSON.stringify({name:e,address:r,username:t,password:s})}),bootstrap.Modal.getInstance(document.getElementById("addServerModal")).hide(),document.getElementById("addServerForm").reset(),showToast("Успех",`Сервер "${e}" успешно добавлен!`),loadServersList()}catch(e){e instanceof SessionExpiredError||showToast("Ошибка",e.message,"error")}finally{hideLoading()}}}async function loadServerDetail(e){currentServerId=e,showLoading();try{var r=await apiRequest("/user/servers/"+e),t=(renderServerDetail(currentServerData=r),await loadServicesList(e),document.getElementById("editServerBtn"));t&&(t.onclick=openEditServerModalFromDetail)}catch(e){e instanceof SessionExpiredError||(showToast("Ошибка","Не удалось загрузить информацию о сервере","error"),showServersList())}finally{hideLoading()}}function renderServerDetail(e){document.getElementById("serverBreadcrumb").textContent=e.name,document.getElementById("serverDetailName").textContent=e.name,document.getElementById("serverDetailAddress").textContent=e.address,document.getElementById("serverDetailUsername").textContent=e.username,document.getElementById("serverDetailCreated").textContent=new Date(e.created_at).toLocaleDateString("ru-RU"),document.getElementById("serverDetailFingerprint").textContent=e.fingerprint}async function handleDeleteServer(){if(currentServerId&&currentServerData&&confirm(`Вы уверены, что хотите удалить сервер "${currentServerData.name}"?`)){showLoading();try{await apiRequest("/user/servers/"+currentServerId,{method:"DELETE"}),showToast("Успех",`Сервер "${currentServerData.name}" удален`),showServersList()}catch(e){e instanceof SessionExpiredError||showToast("Ошибка",e.message,"error")}finally{hideLoading()}}}function openEditServerModalFromDetail(){if(currentServerId&&currentServerData)try{document.getElementById("editServerId").value=currentServerData.id,document.getElementById("editServerName").value=currentServerData.name||"",document.getElementById("editServerAddress").value=currentServerData.address||"",document.getElementById("editServerUsername").value=currentServerData.username||"",document.getElementById("editServerPassword").value="",new bootstrap.Modal(document.getElementById("editServerModal")).show()}catch(e){showToast("Ошибка","Не удалось открыть форму редактирования","error")}else showToast("Ошибка","Данные сервера не загружены","error")}async function handleEditServer(e){e.preventDefault();var e=document.getElementById("editServerId").value,r=document.getElementById("editServerName").value,t=document.getElementById("editServerAddress").value,s=document.getElementById("editServerUsername").value,n=document.getElementById("editServerPassword").value;showLoading();try{var a={name:r,address:t,username:s};n.trim()&&(a.password=n),await apiRequest("/user/servers/"+e,{method:"PATCH",body:JSON.stringify(a)}),bootstrap.Modal.getInstance(document.getElementById("editServerModal")).hide(),document.getElementById("editServerForm").reset(),currentServerData.name=r,currentServerData.address=t,currentServerData.username=s,renderServerDetail(currentServerData),showToast("Успешно","Сервер успешно отредактирован!"),currentServerId===parseInt(e)&&loadServersList()}catch(e){e instanceof SessionExpiredError||showToast("Ошибка",e.message,"error")}finally{hideLoading()}}async function loadServicesList(e,r=!1){r||showLoading();try{var t=await apiRequest(`/user/servers/${e}/services?_t=`+Date.now());allServices=t||[],currentPage=1,renderCurrentPage()}catch(e){r||e instanceof SessionExpiredError||showToast("Ошибка","Не удалось загрузить список служб","error")}finally{r||hideLoading()}}function renderServicesList(e){servicesList.innerHTML="";var r=document.getElementById("refreshFromServerBtn");e&&0!==e.length?(e.forEach(e=>{var r=document.getElementById("serviceCardTemplate").content.cloneNode(!0);r.querySelector(".service-displayed-name").textContent=e.displayed_name,r.querySelector(".service-name").textContent=e.service_name,r.querySelector(".service-status").textContent=e.status||"—",r.querySelector(".service-updated").textContent=e.updated_at?new Date(e.updated_at).toLocaleString("ru-RU"):"—";r.querySelector(".service-card").setAttribute("data-service-id",e.id);var t=r.querySelector(".service-start-btn"),s=r.querySelector(".service-stop-btn"),n=r.querySelector(".service-restart-btn"),a=r.querySelector(".service-delete-btn");t.onclick=function(){controlService(e.id,"start",e.displayed_name)},s.onclick=function(){controlService(e.id,"stop",e.displayed_name)},n.onclick=function(){controlService(e.id,"restart",e.displayed_name)},a.onclick=function(){handleDeleteService(e.id,e.displayed_name)},servicesList.appendChild(r)}),r&&(r.style.display="inline-block")):(servicesList.innerHTML=`
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Список служб пуст
                </div>
            </div>`,r&&(r.style.display="none"))}async function handleAddService(e){if(e.preventDefault(),currentServerId){var e=document.getElementById("serviceDisplayedName").value,r=document.getElementById("serviceName").value;showLoading();try{var t=await apiRequest(`/user/servers/${currentServerId}/services`,{method:"POST",body:JSON.stringify({displayed_name:e,service_name:r})});bootstrap.Modal.getInstance(document.getElementById("addServiceModal")).hide(),document.getElementById("addServiceForm").reset(),showToast("Успех",`Служба "${t.displayed_name}" успешно добавлена!`),loadServicesList(currentServerId)}catch(e){e instanceof SessionExpiredError||showToast("Ошибка",e.message,"error")}finally{hideLoading()}}else showToast("Ошибка","Сначала выберите сервер","error")}async function controlService(r,t,s){if(canPerformAction("service_"+t)){showLoading();try{let e;switch(t){case"start":e=`/user/servers/${currentServerId}/services/${r}/start`;break;case"stop":e=`/user/servers/${currentServerId}/services/${r}/stop`;break;case"restart":e=`/user/servers/${currentServerId}/services/${r}/restart`;break;default:throw new Error("Неизвестное действие")}var n,a,i=await apiRequest(e,{method:"POST"}),o=await apiRequest(`/user/servers/${currentServerId}/services/`+r),d=document.querySelector(`[data-service-id="${r}"]`),c=(d&&(n=d.querySelector(".service-status"),a=d.querySelector(".service-updated"),n&&(n.textContent=o.status||"—"),a)&&(a.textContent=o.updated_at?new Date(o.updated_at).toLocaleString("ru-RU"):"—"),"start"===t?"запущена":"stop"===t?"остановлена":"перезапущена");showToast("Успех",i.message||`Служба "${s}" `+c)}catch(e){e instanceof SessionExpiredError||showToast("Ошибка",`Не удалось выполнить операцию "${t}" для службы "${s}"`,"error")}finally{hideLoading()}}}async function handleDeleteService(e,r){if(confirm(`Вы уверены, что хотите удалить службу "${r}"?`)){showLoading();try{await apiRequest(`/user/servers/${currentServerId}/services/`+e,{method:"DELETE"}),showToast("Успех",`Служба "${r}" удалена`),loadServicesList(currentServerId)}catch(e){e instanceof SessionExpiredError||showToast("Ошибка",e.message,"error")}finally{hideLoading()}}}async function handleRefreshFromServer(){if(currentServerId){showLoading();try{var e=`${API_BASE}/user/servers/${currentServerId}/services?actual=true`,r=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"}),t=r.headers.get("X-Is-Updated"),s=await r.json();allServices=s||[],currentPage=1,renderCurrentPage(),"false"===t?showToast("Предупреждение","Проблемы со связью. Показаны данные из кэша.","warning"):showToast("Успех","Статусы служб обновлены с сервера")}catch(e){showToast("Ошибка","Не удалось обновить статусы","error")}finally{hideLoading()}}else showToast("Ошибка","Сначала выберите сервер","error")}function renderCurrentPage(){if(allServices&&0!==allServices.length){var e,r=getMinItemsForPagination("services");const t=document.getElementById("pageIndicator"),s=document.getElementById("prevPageBtn"),n=document.getElementById("nextPageBtn");allServices.length>r?(r=getPageSize(),totalPages=Math.max(1,Math.ceil(allServices.length/r)),r=(e=((currentPage=currentPage>totalPages?totalPages:currentPage)-1)*r)+r,renderServicesList(allServices.slice(e,r)),t&&(t.style.display="",t.textContent=`Страница ${currentPage} из `+totalPages),s&&(s.style.display="",s.disabled=1===currentPage),n&&(n.style.display="",n.disabled=currentPage===totalPages)):(renderServicesList(allServices),t&&(t.style.display="none"),s&&(s.style.display="none"),n&&(n.style.display="none"),currentPage=1,totalPages=1)}else{renderServicesList([]);const t=document.getElementById("pageIndicator"),s=document.getElementById("prevPageBtn"),n=document.getElementById("nextPageBtn");t&&(t.textContent="Страница 0 из 0",t.style.display="none"),s&&(s.style.display="none"),void(n&&(n.style.display="none"))}}function renderServersCurrentPage(){var e=document.querySelector(".servers-pagination-controls");if(allServers&&0!==allServers.length){var r=getMinItemsForPagination("servers");const n=document.getElementById("serversPageIndicator"),a=document.getElementById("serversPrevPageBtn"),i=document.getElementById("serversNextPageBtn");var t,s,r=allServers.length>r;r?(s=getPageSize(),serversTotalPages=Math.max(1,Math.ceil(allServers.length/s)),s=(t=((serversCurrentPage=serversCurrentPage>serversTotalPages?serversTotalPages:serversCurrentPage)-1)*s)+s,renderServersList(allServers.slice(t,s)),n&&(n.style.display="",n.textContent=`Страница ${serversCurrentPage} из `+serversTotalPages),a&&(a.style.display="",a.disabled=1===serversCurrentPage),i&&(i.style.display="",i.disabled=serversCurrentPage===serversTotalPages),e&&(e.style.display=r?"flex":"none")):(renderServersList(allServers),n&&(n.style.display="none"),a&&(a.style.display="none"),i&&(i.style.display="none"),e&&(e.style.display="none"),serversCurrentPage=1,serversTotalPages=1)}else{renderServersList([]);const n=document.getElementById("serversPageIndicator"),a=document.getElementById("serversPrevPageBtn"),i=document.getElementById("serversNextPageBtn");n&&(n.textContent="Страница 0 из 0",n.style.display="none"),a&&(a.style.display="none"),i&&(i.style.display="none"),void(e&&(e.style.display="none"))}}function setupEventListeners(){document.getElementById("loginForm").addEventListener("submit",handleLogin),document.getElementById("registerForm").addEventListener("submit",handleRegister),document.getElementById("addServerForm").addEventListener("submit",handleAddServer),document.getElementById("editServerForm").addEventListener("submit",handleEditServer),document.getElementById("addServiceForm").addEventListener("submit",handleAddService),document.getElementById("refreshFromServerBtn").addEventListener("click",handleRefreshFromServer),document.getElementById("logoutBtn").addEventListener("click",handleLogout),document.getElementById("deleteServerBtn").addEventListener("click",handleDeleteServer),document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("hidden.bs.modal",function(){document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove()),document.body.classList.remove("modal-open","overflow"),document.body.style.overflow=""})});var e=document.getElementById("prevPageBtn"),r=document.getElementById("nextPageBtn"),e=(e&&e.addEventListener("click",()=>{1<currentPage&&(currentPage--,renderCurrentPage())}),r&&r.addEventListener("click",()=>{currentPage<totalPages&&(currentPage++,renderCurrentPage())}),document.getElementById("serversPrevPageBtn")),r=document.getElementById("serversNextPageBtn");e&&e.addEventListener("click",()=>{1<serversCurrentPage&&(serversCurrentPage--,renderServersCurrentPage())}),r&&r.addEventListener("click",()=>{serversCurrentPage<serversTotalPages&&(serversCurrentPage++,renderServersCurrentPage())})}let isPageVisible=!0;function handlePageBackground(){serviceEventsSource&&(serviceEventsSource.close(),serviceEventsSource=null,sseConnectionStatus="closed",sseReconnectAttempts=0),stopServicePolling(),allServices=[],currentPage=1,totalPages=1}function handlePageResume(){currentUser&&currentServerId&&(loadServicesList(currentServerId,!1),subscribeServiceEvents(currentServerId))}function showLoginPage(){loginPage.classList.remove("hidden"),mainApp.classList.add("hidden"),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,window._sessionExpiredNotified=!1,serviceEventsSource&&(serviceEventsSource.close(),serviceEventsSource=null),stopServicePolling()}function showMainApp(){loginPage.classList.add("hidden"),mainApp.classList.remove("hidden"),currentUser&&(currentUserSpan.textContent=currentUser)}function showServersList(){serversListView.classList.remove("hidden"),serverDetailView.classList.add("hidden"),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,currentServerData=null,allServices=[],currentPage=1,totalPages=1,sseReconnectAttempts=0,serviceEventsSource&&(serviceEventsSource.close(),serviceEventsSource=null,sseConnectionStatus="closed"),stopServicePolling(),loadServersList()}function showServerDetail(e){serversListView.classList.add("hidden"),serverDetailView.classList.remove("hidden"),currentServerId=e,localStorage.setItem("swsm_current_server_id",e),loadServerDetail(e),subscribeServiceEvents(e)}function showLoading(){loadingSpinner.style.display="block"}function hideLoading(){loadingSpinner.style.display="none"}document.addEventListener("visibilitychange",()=>{isPageVisible=!document.hidden,(document.hidden?handlePageBackground:handlePageResume)()},!1);
