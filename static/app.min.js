const CONFIG={SSE_MAX_RECONNECTS:5,SSE_RECONNECT_DELAYS:[1e3,2e3,5e3,1e4,3e4],TOAST_DUPLICATE_CHECK_TIME:3e3,TOAST_AUTO_HIDE_DELAY:3e3,RATE_LIMIT_DELAY:500,RATE_LIMIT_CLEANUP_MS:6e5,PAGE_SIZE_MOBILE:5,PAGE_SIZE_DESKTOP:9,MIN_ITEMS_PAGINATION_MOBILE:5,MIN_ITEMS_PAGINATION_DESKTOP:9,MIN_SERVERS_PAGINATION_MOBILE:5,MIN_SERVERS_PAGINATION_DESKTOP:9,POLLING_INTERVAL:5e3,MAX_SERVICES_CACHE:2e3,MAX_SERVERS_CACHE:1e3};let currentUser=localStorage.getItem("swsm_user"),currentServerId=localStorage.getItem("swsm_current_server_id"),currentServerData=null,isDarkMode="true"===localStorage.getItem("swsm_dark_mode"),allServers=[],serversCurrentPage=1,serversTotalPages=1,allServices=[],currentPage=1,totalPages=1,serviceEventsSource=null,servicePollingInterval=null,sseReconnectAttempts=0,sseConnectionStatus="closed";const REQUEST_RATE_LIMIT=new Map;let cachedPageSize=null,lastWindowWidth=window.innerWidth,toastHistory=[],lastServicesUpdateAt=(window._sessionExpiredNotified=!1,0),sseReconnectTimerId=null;const AppTimers={intervals:new Set,timeouts:new Set,addInterval(e){null!=e&&this.intervals.add(e)},addTimeout(e){null!=e&&this.timeouts.add(e)},clearAll(){for(const e of this.intervals)try{clearInterval(e)}catch(e){}this.intervals.clear();for(const t of this.timeouts)try{clearTimeout(t)}catch(e){}this.timeouts.clear()}},loginPage=document.getElementById("loginPage"),mainApp=document.getElementById("mainApp"),loadingSpinner=document.querySelector(".loading-spinner"),currentUserSpan=document.getElementById("currentUser"),serversListView=document.getElementById("serversListView"),serverDetailView=document.getElementById("serverDetailView"),serversList=document.getElementById("serversList"),servicesList=document.getElementById("servicesList");function debounce(t,r=500){let n;return function(...e){n&&clearTimeout(n),n=setTimeout(()=>{t.apply(this,e),n=null},r)}}function cleanupOldRateLimits(){var e,t,r=Date.now();for([e,t]of REQUEST_RATE_LIMIT.entries())r-t>CONFIG.RATE_LIMIT_CLEANUP_MS&&REQUEST_RATE_LIMIT.delete(e)}function canPerformAction(e){cleanupOldRateLimits();var t=Date.now();return!(t-(REQUEST_RATE_LIMIT.get(e)||0)<CONFIG.RATE_LIMIT_DELAY||(REQUEST_RATE_LIMIT.set(e,t),0))}function isMobileDevice(){return/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)}function getPageSize(){return null!==cachedPageSize&&window.innerWidth===lastWindowWidth||(lastWindowWidth=window.innerWidth,cachedPageSize=window.innerWidth<768?CONFIG.PAGE_SIZE_MOBILE:CONFIG.PAGE_SIZE_DESKTOP),cachedPageSize}function getMinItemsForPagination(e){var t=window.innerWidth<768;return"services"===e?t?CONFIG.MIN_ITEMS_PAGINATION_MOBILE:CONFIG.MIN_ITEMS_PAGINATION_DESKTOP:"servers"===e?t?CONFIG.MIN_SERVERS_PAGINATION_MOBILE:CONFIG.MIN_SERVERS_PAGINATION_DESKTOP:0}function onWindowResize(){cachedPageSize=null}function showToast(e,t,r="success"){const n=e+`|${t}|`+r,s=Date.now();if(toastHistory.find(e=>e.id===n&&s-e.time<CONFIG.TOAST_DUPLICATE_CHECK_TIME))console.warn("[Toast] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ:",n);else{toastHistory.push({id:n,time:s}),toastHistory=(toastHistory=50<toastHistory.length?toastHistory.slice(-30):toastHistory).filter(e=>s-e.time<1e4);var a=document.querySelector(".toast-container");const i=document.getElementById("toastTemplate").cloneNode(!0),o=(i.id="toast-"+Date.now()+Math.random(),i.querySelector(".toast-title").textContent=e,i.querySelector(".toast-message").textContent=t,"error"===r?i.classList.add("text-bg-danger"):"warning"===r?i.classList.add("text-bg-warning"):i.classList.add("text-bg-success"),a.appendChild(i),new bootstrap.Toast(i,{autohide:!0,delay:CONFIG.TOAST_AUTO_HIDE_DELAY}));o.show(),setTimeout(()=>{o.hide()},3e3),i.addEventListener("click",e=>{e.target.classList.contains("btn-close")||o.hide()}),i.addEventListener("hidden.bs.toast",()=>{i.remove()})}}function initTheme(){applyTheme(isDarkMode)}function applyTheme(e){isDarkMode=e,localStorage.setItem("swsm_dark_mode",isDarkMode),isDarkMode?(document.documentElement.setAttribute("data-bs-theme","dark"),document.body.classList.add("dark-mode")):(document.documentElement.removeAttribute("data-bs-theme"),document.body.classList.remove("dark-mode")),updateThemeButton()}function toggleTheme(){applyTheme(!isDarkMode)}function updateThemeButton(){var e=document.getElementById("themeToggleBtn");e&&(isDarkMode?(e.innerHTML="‚òÄÔ∏è",e.title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å–≤–µ—Ç–ª—ã–π —Ä–µ–∂–∏–º"):(e.innerHTML="üåö",e.title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ç—ë–º–Ω—ã–π —Ä–µ–∂–∏–º"),e.className="btn me-2")}document.addEventListener("DOMContentLoaded",function(){initTheme(),currentUser?(showMainApp(),currentServerId?showServerDetail(currentServerId=parseInt(currentServerId)):loadServersList()):showLoginPage(),setupEventListeners()}),window.addEventListener("resize",onWindowResize);class SessionExpiredError extends Error{constructor(e){super(e),this.name="SessionExpiredError"}}async function apiRequest(t,r={}){var n=""+API_BASE+t,r={method:r.method||"GET",headers:{"Content-Type":"application/json",...r.headers},credentials:"include",cache:r.cache||"default",...r};try{var s=await fetch(n,r);if(401===s.status)if(!t.includes("/user/login")){if(!window._sessionExpiredNotified){if(window._sessionExpiredNotified=!0,cleanupOnLogout(),localStorage.removeItem("swsm_user"),localStorage.removeItem("swsm_current_server_id"),currentUser=null,currentServerId=null,currentServerData=null,allServices=[],currentPage=1,allServers=[],serversCurrentPage=1,serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}stopServicePolling(),showToast("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞","–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —Å–Ω–æ–≤–∞.","warning"),showLoginPage()}throw new SessionExpiredError("Session expired")}let e;var a=s.headers.get("Content-Type");if(a&&a.includes("application/json"))e=await s.json();else{var i=await s.text();try{e=JSON.parse(i)}catch{e={message:i}}}if(s.ok)return window._sessionExpiredNotified=!1,e;throw new Error(e.message||e.error||"–û—à–∏–±–∫–∞ HTTP! —Å—Ç–∞—Ç—É—Å: "+s.status)}catch(e){throw e instanceof SessionExpiredError||e instanceof TypeError&&e.message.includes("fetch")&&showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É","error"),e}}function subscribeServiceEvents(r){if(isMobileDevice())startServicePolling(r);else if(serviceEventsSource&&serviceEventsSource.readyState===EventSource.OPEN)sseConnectionStatus="open";else{if(serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}if(sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}var e=API_BASE+"/user/broadcasting";try{serviceEventsSource=new EventSource(e,{withCredentials:!0})}catch(e){return console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å EventSource:",e),void startServicePolling(r)}sseConnectionStatus="connecting",serviceEventsSource.onopen=function(){if(sseConnectionStatus="open",sseReconnectAttempts=0,sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}},serviceEventsSource.onmessage=function(e){try{var t=JSON.parse(e.data).filter(e=>e.server_id===r);0<t.length&&updateServicesStatus(t),sseReconnectAttempts=0}catch(e){console.error("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö SSE:",e)}},serviceEventsSource.onerror=function(e){if(console.error("–û—à–∏–±–∫–∞ SSE:",e),sseConnectionStatus="closed",sseReconnectAttempts>=CONFIG.SSE_MAX_RECONNECTS)startServicePolling(r);else{e=CONFIG.SSE_RECONNECT_DELAYS[sseReconnectAttempts]||3e4;if(sseReconnectAttempts++,sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}sseReconnectTimerId=setTimeout(()=>{sseReconnectTimerId=null,AppTimers.timeouts.delete(sseReconnectTimerId),currentServerId&&subscribeServiceEvents(currentServerId)},e),AppTimers.addTimeout(sseReconnectTimerId)}}}}function startServicePolling(t){stopServicePolling();let r=0;var e=setInterval(async()=>{if(!document.hidden)if(currentServerId!==t)stopServicePolling();else try{var e=await apiRequest(`/user/servers/${t}/services`);Array.isArray(e)&&(updateServicesStatus(e),r=0)}catch(e){r++,console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª–∏–Ω–≥–∞ (${r}/3):`,e),3<=r&&(console.warn("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ø–æ–ª–∏–Ω–≥–∞. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª–∏–Ω–≥–∞."),stopServicePolling())}},CONFIG.POLLING_INTERVAL);AppTimers.addInterval(e),servicePollingInterval=e}function stopServicePolling(){if(servicePollingInterval){try{clearInterval(servicePollingInterval)}catch(e){}AppTimers.intervals.delete(servicePollingInterval),servicePollingInterval=null}}function updateServicesStatus(e){if(Array.isArray(e)&&0!==e.length){const n=new Map(e.map(e=>[e.id,e]));allServices.forEach(e=>{var t=n.get(e.id);t&&(e.status=t.status,e.updated_at=t.updated_at||t.updatedat||t.updatedAt||e.updated_at)}),document.querySelectorAll(".service-card").forEach(e=>{var t,r=parseInt(e.getAttribute("data-service-id")),r=n.get(r);r&&(t=e.querySelector(".service-status"),e=e.querySelector(".service-updated"),t&&t.textContent!==r.status&&(t.textContent=r.status),e)&&(r.updated_at||r.updatedat||r.updatedAt)&&(t=new Date(r.updated_at||r.updatedat||r.updatedAt).toLocaleString("ru-RU"),e.textContent!==t)&&(e.textContent=t)}),lastServicesUpdateAt=Date.now()}}async function handleLogin(e){e.preventDefault();var e=document.getElementById("loginUsername").value,t=document.getElementById("loginPassword").value;showLoading();try{var r=await apiRequest("/user/login",{method:"POST",body:JSON.stringify({login:e,password:t})});currentUser=r.login||r.Login,localStorage.setItem("swsm_user",currentUser),document.documentElement.setAttribute("data-user-logged-in","true"),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,currentServerData=null,allServices=[],currentPage=1,window._sessionExpiredNotified=!1,showToast("–£—Å–ø–µ—Ö","–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"),showMainApp(),setTimeout(()=>{showServersList()},100)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}async function handleRegister(e){e.preventDefault();var e=document.getElementById("registerUsername").value.trim(),t=document.getElementById("registerPassword").value,r=document.getElementById("registerPasswordConfirm").value,n=document.getElementById("registrationKey").value.trim();if(t!==r)showToast("–û—à–∏–±–∫–∞","–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç","error");else if(e.length<4)showToast("–û—à–∏–±–∫–∞","–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤","error");else if(t.length<5)showToast("–û—à–∏–±–∫–∞","–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤","error");else{showLoading();try{await apiRequest("/user/register",{method:"POST",body:JSON.stringify({login:e,password:t,registration_key:n})}),bootstrap.Modal.getInstance(document.getElementById("registerModal")).hide(),document.getElementById("registerForm").reset(),showToast("–£—Å–ø–µ—Ö","–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å.")}catch(e){showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}function cleanupOnLogout(){if(serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}stopServicePolling(),AppTimers.clearAll()}function handleLogout(){cleanupOnLogout(),localStorage.removeItem("swsm_user"),localStorage.removeItem("swsm_current_server_id"),currentUser=null,currentServerId=null,currentServerData=null,allServices=[],currentPage=1,allServers=[],serversCurrentPage=1,window._sessionExpiredNotified=!1,document.documentElement.removeAttribute("data-user-logged-in"),showLoginPage(),showToast("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è","–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã")}async function loadServersList(){showLoading();try{var e=await apiRequest("/user/servers");allServers=(e||[]).slice(0,CONFIG.MAX_SERVERS_CACHE),serversCurrentPage=1,renderServersCurrentPage()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤","error")}finally{hideLoading()}}function renderServersList(e){serversList.innerHTML="",e&&0!==e.length?e.forEach(e=>{var t=document.createElement("div"),r=(t.className="col-md-6 col-lg-4",document.createElement("div")),n=(r.className="card h-100 shadow-sm service-card",document.createElement("div")),s=(n.className="card-body",document.createElement("h5")),a=(s.className="card-title",s.innerHTML='<i class="bi bi-server me-2"></i>',document.createTextNode(e.name||"")),a=(s.appendChild(a),document.createElement("p")),i=(a.className="card-text",document.createElement("small")),o=(i.className="text-muted d-block",i.innerHTML='<i class="bi bi-geo-alt me-1"></i>',i.appendChild(document.createTextNode(e.address||"")),document.createElement("small")),d=(o.className="text-muted d-block",o.innerHTML='<i class="bi bi-person me-1"></i>',o.appendChild(document.createTextNode(e.username||"")),document.createElement("small"));d.className="text-muted d-block",d.innerHTML='<i class="bi bi-calendar me-1"></i>';try{d.appendChild(document.createTextNode(new Date(e.created_at).toLocaleDateString("ru-RU")))}catch(e){d.appendChild(document.createTextNode(""))}var c=document.createElement("small"),i=(c.className="text-muted d-block",c.innerHTML='<i class="bi bi-fingerprint me-1"></i>',c.appendChild(document.createTextNode(e.fingerprint||"")),a.appendChild(i),a.appendChild(o),a.appendChild(d),a.appendChild(c),n.appendChild(s),n.appendChild(a),document.createElement("div")),o=(i.className="card-footer",document.createElement("button"));o.className="btn btn-primary btn-sm w-100",o.innerHTML='<i class="bi bi-list-task me-1"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',o.onclick=()=>showServerDetail(e.id),i.appendChild(o),r.appendChild(n),r.appendChild(i),t.appendChild(r),serversList.appendChild(t)}):serversList.innerHTML=`
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="bi bi-info-circle me-2"></i>
                    –°–µ—Ä–≤–µ—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.
                </div>
            </div>
        `}async function handleAddServer(e){if(e.preventDefault(),canPerformAction("addServer")){var e=document.getElementById("serverName").value,t=document.getElementById("serverAddress").value,r=document.getElementById("serverUsername").value,n=document.getElementById("serverPassword").value;showLoading();try{await apiRequest("/user/servers",{method:"POST",body:JSON.stringify({name:e,address:t,username:r,password:n})}),bootstrap.Modal.getInstance(document.getElementById("addServerModal")).hide(),document.getElementById("addServerForm").reset(),showToast("–£—Å–ø–µ—Ö",`–°–µ—Ä–≤–µ—Ä "${e}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!`),loadServersList()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}async function loadServerDetail(e){currentServerId=e,showLoading();try{var t=await apiRequest("/user/servers/"+e),r=(renderServerDetail(currentServerData=t),await loadServicesList(e),document.getElementById("editServerBtn"));r&&(r.onclick=openEditServerModalFromDetail)}catch(e){e instanceof SessionExpiredError||(showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ","error"),showServersList())}finally{hideLoading()}}function renderServerDetail(e){document.getElementById("serverBreadcrumb").textContent=e.name,document.getElementById("serverDetailName").textContent=e.name,document.getElementById("serverDetailAddress").textContent=e.address,document.getElementById("serverDetailUsername").textContent=e.username,document.getElementById("serverDetailCreated").textContent=new Date(e.created_at).toLocaleDateString("ru-RU"),document.getElementById("serverDetailFingerprint").textContent=e.fingerprint}async function handleDeleteServer(){if(currentServerId&&currentServerData&&confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä "${currentServerData.name}"?`)){showLoading();try{await apiRequest("/user/servers/"+currentServerId,{method:"DELETE"}),showToast("–£—Å–ø–µ—Ö",`–°–µ—Ä–≤–µ—Ä "${currentServerData.name}" —É–¥–∞–ª–µ–Ω`),showServersList()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}function openEditServerModalFromDetail(){if(currentServerId&&currentServerData)try{document.getElementById("editServerId").value=currentServerData.id,document.getElementById("editServerName").value=currentServerData.name||"",document.getElementById("editServerAddress").value=currentServerData.address||"",document.getElementById("editServerUsername").value=currentServerData.username||"",document.getElementById("editServerPassword").value="",new bootstrap.Modal(document.getElementById("editServerModal")).show()}catch(e){showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è","error")}else showToast("–û—à–∏–±–∫–∞","–î–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã","error")}async function handleEditServer(e){e.preventDefault();var e=document.getElementById("editServerId").value,t=document.getElementById("editServerName").value,r=document.getElementById("editServerAddress").value,n=document.getElementById("editServerUsername").value,s=document.getElementById("editServerPassword").value;showLoading();try{var a={name:t,address:r,username:n};s.trim()&&(a.password=s),await apiRequest("/user/servers/"+e,{method:"PATCH",body:JSON.stringify(a)}),bootstrap.Modal.getInstance(document.getElementById("editServerModal")).hide(),document.getElementById("editServerForm").reset(),currentServerData.name=t,currentServerData.address=r,currentServerData.username=n,renderServerDetail(currentServerData),showToast("–£—Å–ø–µ—à–Ω–æ","–°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω!"),currentServerId===parseInt(e)&&loadServersList()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}async function loadServicesList(e,t=!1){t||showLoading();try{var r=await apiRequest(`/user/servers/${e}/services?_t=`+Date.now());allServices=(r||[]).slice(0,CONFIG.MAX_SERVICES_CACHE),currentPage=1,lastServicesUpdateAt=Date.now(),renderCurrentPage()}catch(e){throw t||e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª—É–∂–±","error"),e}finally{t||hideLoading()}}function renderServicesList(e){servicesList.innerHTML="";var t=document.getElementById("refreshFromServerBtn");e&&0!==e.length?(e.forEach(e=>{var t=document.getElementById("serviceCardTemplate").content.cloneNode(!0);t.querySelector(".service-displayed-name").textContent=e.displayed_name,t.querySelector(".service-name").textContent=e.service_name,t.querySelector(".service-status").textContent=e.status||"‚Äî",t.querySelector(".service-updated").textContent=e.updated_at?new Date(e.updated_at).toLocaleString("ru-RU"):"‚Äî";t.querySelector(".service-card").setAttribute("data-service-id",e.id);var r=t.querySelector(".service-start-btn"),n=t.querySelector(".service-stop-btn"),s=t.querySelector(".service-restart-btn"),a=t.querySelector(".service-delete-btn");r.onclick=function(){controlService(e.id,"start",e.displayed_name)},n.onclick=function(){controlService(e.id,"stop",e.displayed_name)},s.onclick=function(){controlService(e.id,"restart",e.displayed_name)},a.onclick=function(){handleDeleteService(e.id,e.displayed_name)},servicesList.appendChild(t)}),t&&(t.style.display="inline-block")):(servicesList.innerHTML=`
            <div class="col-12">
                <div class="alert alert-warning text-center">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    –°–ø–∏—Å–æ–∫ —Å–ª—É–∂–± –ø—É—Å—Ç
                </div>
            </div>`,t&&(t.style.display="none"))}async function handleAddService(e){if(e.preventDefault(),currentServerId){var e=document.getElementById("serviceDisplayedName").value,t=document.getElementById("serviceName").value;showLoading();try{var r=await apiRequest(`/user/servers/${currentServerId}/services`,{method:"POST",body:JSON.stringify({displayed_name:e,service_name:t})});bootstrap.Modal.getInstance(document.getElementById("addServiceModal")).hide(),document.getElementById("addServiceForm").reset(),showToast("–£—Å–ø–µ—Ö",`–°–ª—É–∂–±–∞ "${r.displayed_name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!`),loadServicesList(currentServerId)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}else showToast("–û—à–∏–±–∫–∞","–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä","error")}async function controlService(t,r,n){if(canPerformAction("service_"+r)){showLoading();try{let e;switch(r){case"start":e=`/user/servers/${currentServerId}/services/${t}/start`;break;case"stop":e=`/user/servers/${currentServerId}/services/${t}/stop`;break;case"restart":e=`/user/servers/${currentServerId}/services/${t}/restart`;break;default:throw new Error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")}var s,a,i=await apiRequest(e,{method:"POST"}),o=await apiRequest(`/user/servers/${currentServerId}/services/`+t),d=document.querySelector(`[data-service-id="${t}"]`),c=(d&&(s=d.querySelector(".service-status"),a=d.querySelector(".service-updated"),s&&(s.textContent=o.status||"‚Äî"),a)&&(a.textContent=o.updated_at?new Date(o.updated_at).toLocaleString("ru-RU"):"‚Äî"),"start"===r?"–∑–∞–ø—É—â–µ–Ω–∞":"stop"===r?"–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞":"–ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞");showToast("–£—Å–ø–µ—Ö",i.message||`–°–ª—É–∂–±–∞ "${n}" `+c)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é "${r}" –¥–ª—è —Å–ª—É–∂–±—ã "${n}"`,"error")}finally{hideLoading()}}}async function handleDeleteService(e,t){if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–ª—É–∂–±—É "${t}"?`)){showLoading();try{await apiRequest(`/user/servers/${currentServerId}/services/`+e,{method:"DELETE"}),showToast("–£—Å–ø–µ—Ö",`–°–ª—É–∂–±–∞ "${t}" —É–¥–∞–ª–µ–Ω–∞`),loadServicesList(currentServerId)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}async function handleRefreshFromServer(){if(currentServerId){showLoading();try{var e=`${API_BASE}/user/servers/${currentServerId}/services?actual=true`,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"}),r=t.headers.get("X-Is-Updated"),n=await t.json();allServices=(n||[]).slice(0,CONFIG.MAX_SERVICES_CACHE),currentPage=1,lastServicesUpdateAt=Date.now(),renderCurrentPage(),"false"===r?showToast("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ","–ü—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–≤—è–∑—å—é. –ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞.","warning"):showToast("–£—Å–ø–µ—Ö","–°—Ç–∞—Ç—É—Å—ã —Å–ª—É–∂–± –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞")}catch(e){showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã","error")}finally{hideLoading()}}else showToast("–û—à–∏–±–∫–∞","–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä","error")}let availableServices=[];async function loadAvailableServices(e){try{var t=await apiRequest(`/user/servers/${e}/services/available`);return availableServices=t.services||[]}catch(e){return console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É–∂–±:",e),showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª—É–∂–±","error"),[]}}function renderCurrentPage(){if(allServices&&0!==allServices.length){var e,t=getMinItemsForPagination("services");const r=document.getElementById("pageIndicator"),n=document.getElementById("prevPageBtn"),s=document.getElementById("nextPageBtn");allServices.length>t?(t=getPageSize(),totalPages=Math.max(1,Math.ceil(allServices.length/t)),t=(e=((currentPage=currentPage>totalPages?totalPages:currentPage)-1)*t)+t,renderServicesList(allServices.slice(e,t)),r&&(r.style.display="",r.textContent=`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ `+totalPages),n&&(n.style.display="",n.disabled=1===currentPage),s&&(s.style.display="",s.disabled=currentPage===totalPages)):(renderServicesList(allServices),r&&(r.style.display="none"),n&&(n.style.display="none"),s&&(s.style.display="none"),currentPage=1,totalPages=1)}else{renderServicesList([]);const r=document.getElementById("pageIndicator"),n=document.getElementById("prevPageBtn"),s=document.getElementById("nextPageBtn");r&&(r.textContent="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 0 –∏–∑ 0",r.style.display="none"),n&&(n.style.display="none"),void(s&&(s.style.display="none"))}}function renderServersCurrentPage(){var e=document.querySelector(".servers-pagination-controls");if(allServers&&0!==allServers.length){var t=getMinItemsForPagination("servers");const s=document.getElementById("serversPageIndicator"),a=document.getElementById("serversPrevPageBtn"),i=document.getElementById("serversNextPageBtn");var r,n,t=allServers.length>t;t?(n=getPageSize(),serversTotalPages=Math.max(1,Math.ceil(allServers.length/n)),n=(r=((serversCurrentPage=serversCurrentPage>serversTotalPages?serversTotalPages:serversCurrentPage)-1)*n)+n,renderServersList(allServers.slice(r,n)),s&&(s.style.display="",s.textContent=`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${serversCurrentPage} –∏–∑ `+serversTotalPages),a&&(a.style.display="",a.disabled=1===serversCurrentPage),i&&(i.style.display="",i.disabled=serversCurrentPage===serversTotalPages),e&&(e.style.display=t?"flex":"none")):(renderServersList(allServers),s&&(s.style.display="none"),a&&(a.style.display="none"),i&&(i.style.display="none"),e&&(e.style.display="none"),serversCurrentPage=1,serversTotalPages=1)}else{renderServersList([]);const s=document.getElementById("serversPageIndicator"),a=document.getElementById("serversPrevPageBtn"),i=document.getElementById("serversNextPageBtn");s&&(s.textContent="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 0 –∏–∑ 0",s.style.display="none"),a&&(a.style.display="none"),i&&(i.style.display="none"),void(e&&(e.style.display="none"))}}function setupEventListeners(){var e=document.getElementById("loginForm"),e=(e&&e.addEventListener("submit",handleLogin),document.getElementById("registerForm")),e=(e&&e.addEventListener("submit",handleRegister),document.getElementById("addServerForm")),e=(e&&e.addEventListener("submit",handleAddServer),document.getElementById("editServerForm")),e=(e&&e.addEventListener("submit",handleEditServer),document.getElementById("addServiceForm")),e=(e&&e.addEventListener("submit",handleAddService),document.getElementById("refreshFromServerBtn")),e=(e&&e.addEventListener("click",handleRefreshFromServer),document.getElementById("logoutBtn")),e=(e&&e.addEventListener("click",handleLogout),document.getElementById("deleteServerBtn")),e=(e&&e.addEventListener("click",handleDeleteServer),document.querySelectorAll(".modal").forEach(e=>{e.addEventListener("hidden.bs.modal",function(){document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove()),document.body.classList.remove("modal-open","overflow"),document.body.style.overflow=""})}),document.getElementById("prevPageBtn")),t=document.getElementById("nextPageBtn"),e=(e&&e.addEventListener("click",()=>{1<currentPage&&(currentPage--,renderCurrentPage())}),t&&t.addEventListener("click",()=>{currentPage<totalPages&&(currentPage++,renderCurrentPage())}),document.getElementById("serversPrevPageBtn")),t=document.getElementById("serversNextPageBtn");e&&e.addEventListener("click",()=>{1<serversCurrentPage&&(serversCurrentPage--,renderServersCurrentPage())}),t&&t.addEventListener("click",()=>{serversCurrentPage<serversTotalPages&&(serversCurrentPage++,renderServersCurrentPage())})}document.getElementById("addServiceModal").addEventListener("show.bs.modal",async()=>{if(currentServerId){const r=document.getElementById("serviceSelect");r.innerHTML='<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±...</option>';var e=await loadAvailableServices(currentServerId);r.innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É --</option>',e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)})}}),document.getElementById("serviceSelect").addEventListener("change",e=>{e=e.target.value;document.getElementById("serviceDisplayName").value=e}),document.getElementById("addServiceModal").addEventListener("hide.bs.modal",()=>{document.getElementById("addServiceForm").reset(),document.getElementById("serviceSelect").innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É --</option>',document.getElementById("serviceDisplayName").value=""}),document.getElementById("addServiceModal").addEventListener("show.bs.modal",async()=>{if(currentServerId){const r=document.getElementById("serviceSelect");r.disabled=!0,r.innerHTML='<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±...</option>';var e=await loadAvailableServices(currentServerId);r.disabled=!1,r.innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É --</option>',e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)})}}),document.getElementById("serviceSelect").addEventListener("change",e=>{e=e.target.value;document.getElementById("serviceDisplayName").value=e}),document.getElementById("addServiceBtn").addEventListener("click",async()=>{var e=document.getElementById("serviceSelect").value,t=document.getElementById("serviceDisplayName").value;if(e){if(canPerformAction("addService")){showLoading();try{await apiRequest(`/user/servers/${currentServerId}/services`,{method:"POST",body:JSON.stringify({service_name:e,displayed_name:t||e})}),showToast("–£—Å–ø–µ—Ö","–°–ª—É–∂–±–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞"),bootstrap.Modal.getInstance(document.getElementById("addServiceModal")).hide(),loadServicesList(currentServerId)}catch(e){showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}else showToast("–û—à–∏–±–∫–∞","–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É","error")});let isPageVisible=!0;function handlePageBackground(){if(serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null,sseConnectionStatus="closed",sseReconnectAttempts=0}if(sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}stopServicePolling()}const MIN_RESUME_INTERVAL=1e3;let lastResumeTime=0;function handlePageResume(){var e,t=Date.now();t-lastResumeTime<MIN_RESUME_INTERVAL||(lastResumeTime=t,currentUser&&currentServerId&&((!serviceEventsSource||serviceEventsSource&&serviceEventsSource.readyState===EventSource.CLOSED)&&subscribeServiceEvents(currentServerId),t=Array.isArray(allServices)&&0<allServices.length,e=0===lastServicesUpdateAt||1e4<Date.now()-lastServicesUpdateAt,!t||e?loadServicesList(currentServerId,!0).catch(e=>{console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É:",e),startServicePolling(currentServerId)}):setTimeout(()=>{serviceEventsSource&&serviceEventsSource.readyState===EventSource.OPEN||startServicePolling(currentServerId)},1200)))}function showLoginPage(){if(loginPage&&loginPage.classList.remove("hidden"),mainApp&&mainApp.classList.add("hidden"),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,window._sessionExpiredNotified=!1,serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}stopServicePolling()}function showMainApp(){loginPage&&loginPage.classList.add("hidden"),mainApp&&mainApp.classList.remove("hidden"),currentUser&&currentUserSpan&&(currentUserSpan.textContent=currentUser)}function showServersList(){if(serversListView.classList.remove("hidden"),serverDetailView.classList.add("hidden"),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,currentServerData=null,allServices=[],currentPage=1,totalPages=1,sseReconnectAttempts=0,serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null,sseConnectionStatus="closed"}stopServicePolling(),loadServersList()}function showServerDetail(e){serversListView.classList.add("hidden"),serverDetailView.classList.remove("hidden"),currentServerId=e,localStorage.setItem("swsm_current_server_id",e),loadServerDetail(e),subscribeServiceEvents(e)}function showLoading(){loadingSpinner&&(loadingSpinner.style.display="block")}function hideLoading(){loadingSpinner&&(loadingSpinner.style.display="none")}document.addEventListener("visibilitychange",()=>{isPageVisible=!document.hidden,(document.hidden?handlePageBackground:handlePageResume)()},!1),window.addEventListener("beforeunload",()=>{if(AppTimers.clearAll(),serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}});