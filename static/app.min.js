const CONFIG={SSE_MAX_RECONNECTS:5,SSE_RECONNECT_DELAYS:[1e3,2e3,5e3,1e4,3e4],TOAST_DUPLICATE_CHECK_TIME:3e3,TOAST_AUTO_HIDE_DELAY:3e3,RATE_LIMIT_DELAY:500,RATE_LIMIT_CLEANUP_MS:6e5,PAGE_SIZE_MOBILE:5,PAGE_SIZE_DESKTOP:9,MIN_ITEMS_PAGINATION_MOBILE:5,MIN_ITEMS_PAGINATION_DESKTOP:9,MIN_SERVERS_PAGINATION_MOBILE:5,MIN_SERVERS_PAGINATION_DESKTOP:9,POLLING_INTERVAL:5e3,MAX_SERVICES_CACHE:2e3,MAX_SERVERS_CACHE:1e3};let currentUser=localStorage.getItem("swsm_user"),currentServerId=localStorage.getItem("swsm_current_server_id"),currentServerData=null,isDarkMode="true"===localStorage.getItem("swsm_dark_mode");const LS_SERVERS_PAGE_KEY="swsm_servers_page",LS_SERVICES_PAGE_KEY="swsm_services_page";let allServers=[],serversCurrentPage=parseInt(localStorage.getItem(LS_SERVERS_PAGE_KEY)||"1",10),serversTotalPages=1,allServices=[],currentPage=parseInt(localStorage.getItem(LS_SERVICES_PAGE_KEY)||"1",10),totalPages=1,serviceEventsSource=null,servicePollingInterval=null,sseReconnectAttempts=0,sseConnectionStatus="closed",serverEventsSource=null,serverPollingInterval=null,serverSseReconnectTimerId=null,serverSseReconnectAttempts=0;const REQUEST_RATE_LIMIT=new Map;let cachedPageSize=null,lastWindowWidth=window.innerWidth,resizeDebounceTimer=null,toastHistory=[];window._sessionExpiredNotified=!1;let lastMobileView=null,lastServicesUpdateAt=0,sseReconnectTimerId=null;const AppTimers={intervals:new Set,timeouts:new Set,addInterval(e){null!=e&&this.intervals.add(e)},addTimeout(e){null!=e&&this.timeouts.add(e)},clearAll(){for(const e of this.intervals)try{clearInterval(e)}catch(e){}this.intervals.clear();for(const e of this.timeouts)try{clearTimeout(e)}catch(e){}this.timeouts.clear()}},loginPage=document.getElementById("loginPage"),mainApp=document.getElementById("mainApp"),loadingSpinner=document.querySelector(".loading-spinner"),currentUserSpan=document.getElementById("currentUser"),serversListView=document.getElementById("serversListView"),serverDetailView=document.getElementById("serverDetailView"),serversList=document.getElementById("serversList"),servicesList=document.getElementById("servicesList");function debounce(e,t=500){let r;return function(...s){r&&clearTimeout(r),r=setTimeout((()=>{e.apply(this,s),r=null}),t)}}function cleanupOldRateLimits(){const e=Date.now();for(const[t,r]of REQUEST_RATE_LIMIT.entries())e-r>CONFIG.RATE_LIMIT_CLEANUP_MS&&REQUEST_RATE_LIMIT.delete(t)}function canPerformAction(e){cleanupOldRateLimits();const t=Date.now();return!(t-(REQUEST_RATE_LIMIT.get(e)||0)<CONFIG.RATE_LIMIT_DELAY)&&(REQUEST_RATE_LIMIT.set(e,t),!0)}function isMobileDevice(){const e=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),t=window.innerWidth<768;return e||t}function getPageSize(){return null!==cachedPageSize&&window.innerWidth===lastWindowWidth||(lastWindowWidth=window.innerWidth,cachedPageSize=window.innerWidth<768?CONFIG.PAGE_SIZE_MOBILE:CONFIG.PAGE_SIZE_DESKTOP),cachedPageSize}function switchConnectionsMode(){if(!currentUser)return;const e=isMobileDevice();if(lastMobileView!==e){if(lastMobileView=e,serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}if(stopServicePolling(),serverEventsSource){try{serverEventsSource.close()}catch(e){}serverEventsSource=null}stopServerPolling(),subscribeServerEvents(),currentServerId&&subscribeServiceEvents(currentServerId)}}function getMinItemsForPagination(e){const t=window.innerWidth<768;return"services"===e?t?CONFIG.MIN_ITEMS_PAGINATION_MOBILE:CONFIG.MIN_ITEMS_PAGINATION_DESKTOP:"servers"===e?t?CONFIG.MIN_SERVERS_PAGINATION_MOBILE:CONFIG.MIN_SERVERS_PAGINATION_DESKTOP:0}function getServerStatusClass(e){switch((e||"").toUpperCase()){case"OK":return"server-status-ok";case"DEGRADED":return"server-status-degraded";case"DOWN":case"UNREACHABLE":return"server-status-down";default:return"server-status-pending"}}function onWindowResize(){cachedPageSize=null,resizeDebounceTimer&&(clearTimeout(resizeDebounceTimer),AppTimers.timeouts.delete(resizeDebounceTimer)),resizeDebounceTimer=setTimeout((()=>{AppTimers.timeouts.delete(resizeDebounceTimer),resizeDebounceTimer=null,switchConnectionsMode()}),300),AppTimers.addTimeout(resizeDebounceTimer)}function showToast(e,t,r="success"){const s=`${e}|${t}|${r}`,n=Date.now();if(toastHistory.find((e=>e.id===s&&n-e.time<CONFIG.TOAST_DUPLICATE_CHECK_TIME)))return void console.warn("[Toast] –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–æ:",s);toastHistory.push({id:s,time:n}),toastHistory.length>50&&(toastHistory=toastHistory.slice(-30)),toastHistory=toastHistory.filter((e=>n-e.time<1e4));const a=document.querySelector(".toast-container"),o=document.getElementById("toastTemplate").cloneNode(!0);o.id="toast-"+Date.now()+Math.random(),o.querySelector(".toast-title").textContent=e,o.querySelector(".toast-message").textContent=t,"error"===r?o.classList.add("text-bg-danger"):"warning"===r?o.classList.add("text-bg-warning"):o.classList.add("text-bg-success"),a.appendChild(o);const i=new bootstrap.Toast(o,{autohide:!0,delay:CONFIG.TOAST_AUTO_HIDE_DELAY});i.show(),setTimeout((()=>{i.hide()}),3e3),o.addEventListener("click",(e=>{e.target.classList.contains("btn-close")||i.hide()})),o.addEventListener("hidden.bs.toast",(()=>{o.remove()}))}function initTheme(){applyTheme(isDarkMode)}function applyTheme(e){isDarkMode=e,localStorage.setItem("swsm_dark_mode",isDarkMode),isDarkMode?(document.documentElement.setAttribute("data-bs-theme","dark"),document.body.classList.add("dark-mode")):(document.documentElement.removeAttribute("data-bs-theme"),document.body.classList.remove("dark-mode")),updateThemeButton()}function toggleTheme(){applyTheme(!isDarkMode)}function updateThemeButton(){const e=document.getElementById("themeToggleBtn");e&&(isDarkMode?(e.innerHTML="‚òÄÔ∏è",e.title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Å–≤–µ—Ç–ª—ã–π —Ä–µ–∂–∏–º",e.className="btn me-2"):(e.innerHTML="üåö",e.title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å—Å—è –Ω–∞ —Ç—ë–º–Ω—ã–π —Ä–µ–∂–∏–º",e.className="btn me-2"))}document.addEventListener("DOMContentLoaded",(function(){initTheme(),currentUser?(showMainApp(),subscribeServerEvents(),currentServerId?(currentServerId=parseInt(currentServerId),showServerDetail(currentServerId)):loadServersList()):showLoginPage(),setupEventListeners()})),window.addEventListener("resize",onWindowResize);class SessionExpiredError extends Error{constructor(e){super(e),this.name="SessionExpiredError"}}async function apiRequest(e,t={}){const r=`${API_BASE}${e}`,s={method:t.method||"GET",headers:{"Content-Type":"application/json",...t.headers},credentials:"include",cache:t.cache||"default",...t};try{const t=await fetch(r,s);if(401===t.status){if(!e.includes("/user/login")){if(!window._sessionExpiredNotified){if(window._sessionExpiredNotified=!0,cleanupOnLogout(),localStorage.removeItem("swsm_user"),localStorage.removeItem("swsm_current_server_id"),currentUser=null,currentServerId=null,currentServerData=null,allServices=[],currentPage=1,allServers=[],serversCurrentPage=1,serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}stopServicePolling(),showToast("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞","–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —Å–Ω–æ–≤–∞.","warning"),showLoginPage()}throw new SessionExpiredError("Session expired")}}let n;const a=t.headers.get("Content-Type");if(a&&a.includes("application/json"))n=await t.json();else{const e=await t.text();try{n=JSON.parse(e)}catch{n={message:e}}}if(!t.ok)throw new Error(n.message||n.error||`–û—à–∏–±–∫–∞ HTTP! —Å—Ç–∞—Ç—É—Å: ${t.status}`);return window._sessionExpiredNotified=!1,n}catch(e){if(e instanceof SessionExpiredError)throw e;throw e instanceof TypeError&&e.message.includes("fetch")&&showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–µ—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É","error"),e}}function subscribeServiceEvents(e){if(isMobileDevice())return void startServicePolling(e);if(serviceEventsSource&&serviceEventsSource.readyState===EventSource.OPEN)return void(sseConnectionStatus="open");if(serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}if(sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}const t=`${API_BASE}/user/broadcasting?stream=services`;try{serviceEventsSource=new EventSource(t,{withCredentials:!0})}catch(t){return console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å EventSource:",t),void startServicePolling(e)}sseConnectionStatus="connecting",serviceEventsSource.onopen=function(){if(sseConnectionStatus="open",sseReconnectAttempts=0,sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}},serviceEventsSource.onmessage=function(t){try{const r=JSON.parse(t.data).filter((t=>t.server_id===e));r.length>0&&updateServicesStatus(r),sseReconnectAttempts=0}catch(e){console.error("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö SSE:",e)}},serviceEventsSource.onerror=function(t){if(console.error("–û—à–∏–±–∫–∞ SSE:",t),sseConnectionStatus="closed",sseReconnectAttempts>=CONFIG.SSE_MAX_RECONNECTS)return void startServicePolling(e);const r=CONFIG.SSE_RECONNECT_DELAYS[sseReconnectAttempts]||3e4;if(sseReconnectAttempts++,sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}sseReconnectTimerId=setTimeout((()=>{const e=sseReconnectTimerId;AppTimers.timeouts.delete(e),sseReconnectTimerId=null,currentServerId&&subscribeServiceEvents(currentServerId)}),r),AppTimers.addTimeout(sseReconnectTimerId)}}function subscribeServerEvents(){if(isMobileDevice())return void startServerPolling();if(serverEventsSource)try{serverEventsSource.close(),serverEventsSource=null}catch(e){}if(serverSseReconnectTimerId){try{clearTimeout(serverSseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(serverSseReconnectTimerId),serverSseReconnectTimerId=null}const e=`${API_BASE}/user/broadcasting?stream=servers`;try{serverEventsSource=new EventSource(e,{withCredentials:!0})}catch(e){return console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å EventSource –¥–ª—è —Å–µ—Ä–≤–µ—Ä–æ–≤:",e),void startServerPolling()}serverSseReconnectAttempts=0,serverEventsSource.onopen=function(){if(serverSseReconnectAttempts=0,serverSseReconnectTimerId){try{clearTimeout(serverSseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(serverSseReconnectTimerId),serverSseReconnectTimerId=null}},serverEventsSource.onmessage=function(e){try{const t=JSON.parse(e.data);if(!serversListView.classList.contains("hidden")&&serverDetailView.classList.contains("hidden"))updateServersStatus(t);else if(currentServerId){const e=t.filter((e=>e.server_id===currentServerId));e.length>0&&updateServersStatus(e)}serverSseReconnectAttempts=0}catch(e){console.error("–û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö SSE (servers):",e)}},serverEventsSource.onerror=function(e){if(console.error("–û—à–∏–±–∫–∞ SSE (servers):",e),serverSseReconnectAttempts>=CONFIG.SSE_MAX_RECONNECTS){try{serverEventsSource.close()}catch(e){}if(serverEventsSource=null,startServerPolling(),serverSseReconnectTimerId){try{clearTimeout(serverSseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(serverSseReconnectTimerId),serverSseReconnectTimerId=null}return}const t=CONFIG.SSE_RECONNECT_DELAYS[serverSseReconnectAttempts]||3e4;if(serverSseReconnectAttempts++,serverSseReconnectTimerId){try{clearTimeout(serverSseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(serverSseReconnectTimerId),serverSseReconnectTimerId=null}serverSseReconnectTimerId=setTimeout((()=>{const e=serverSseReconnectTimerId;AppTimers.timeouts.delete(e),serverSseReconnectTimerId=null,subscribeServerEvents()}),t),AppTimers.addTimeout(serverSseReconnectTimerId)}}function startServicePolling(e){stopServicePolling();let t=0;const r=async()=>{if(!document.hidden)if(currentServerId===e)try{const r=await apiRequest(`/user/servers/${e}/services`);Array.isArray(r)&&(updateServicesStatus(r),t=0)}catch(e){t++,console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª–∏–Ω–≥–∞ (${t}/3):`,e),t>=3&&stopServicePolling()}else stopServicePolling()};r();const s=setInterval(r,CONFIG.POLLING_INTERVAL);AppTimers.addInterval(s),servicePollingInterval=s}function stopServicePolling(){if(servicePollingInterval){try{clearInterval(servicePollingInterval)}catch(e){}AppTimers.intervals.delete(servicePollingInterval),servicePollingInterval=null}}function updateServicesStatus(e){if(!Array.isArray(e)||0===e.length)return;const t=new Map;e.forEach((e=>{const r=e.id;r&&t.set(Number(r),e)})),allServices.forEach((e=>{const r=t.get(e.id);r&&(e.status=r.status,e.updated_at=r.updated_at||r.updatedat||r.updatedAt||e.updated_at)})),document.querySelectorAll(".service-card").forEach((e=>{const r=parseInt(e.getAttribute("data-service-id")),s=t.get(r);if(!s)return;const n=e.querySelector(".service-status"),a=e.querySelector(".service-updated");if(n&&(n.textContent=s.status||"‚Äî"),a){const e=s.updated_at||s.updatedat||s.updatedAt;if(e){const t=new Date(e).toLocaleString("ru-RU");a.textContent=t}}})),lastServicesUpdateAt=Date.now()}function startServerPolling(){if(serverPollingInterval)return;stopServerPolling();let e=0;const t=setInterval((async()=>{if(!document.hidden)try{if(!serversListView.classList.contains("hidden")&&serverDetailView.classList.contains("hidden")){const t=await apiRequest("/user/servers/statuses");Array.isArray(t)&&(updateServersStatus(t),e=0)}else if(currentServerId)try{const t=await apiRequest(`/user/servers/${currentServerId}/status`);updateServersStatus([{server_id:currentServerId,status:t.status||"UNKNOWN"}]),e=0}catch(t){e++,console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª–∏–Ω–≥–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (${e}/3):`,t),e>=3&&(console.warn("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ø–æ–ª–∏–Ω–≥–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª–∏–Ω–≥–∞."),stopServerPolling())}}catch(t){e++,console.error(`–û—à–∏–±–∫–∞ –ø–æ–ª–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤ (${e}/3):`,t),e>=3&&(console.warn("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫ –ø–æ–ª–∏–Ω–≥–∞ —Å–µ—Ä–≤–µ—Ä–æ–≤. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–ª–∏–Ω–≥–∞."),stopServerPolling())}}),CONFIG.POLLING_INTERVAL);AppTimers.addInterval(t),serverPollingInterval=t}function stopServerPolling(){if(serverPollingInterval){try{clearInterval(serverPollingInterval)}catch(e){}AppTimers.intervals.delete(serverPollingInterval),serverPollingInterval=null}}function updateServerStatusIndicator(e,t){if(e.classList.remove("server-status-ok","server-status-degraded","server-status-down","server-status-pending"),t)switch(t.toUpperCase()){case"OK":e.classList.add("server-status-ok");break;case"DEGRADED":e.classList.add("server-status-degraded");break;case"DOWN":case"UNREACHABLE":e.classList.add("server-status-down");break;default:e.classList.add("server-status-pending")}else e.classList.add("server-status-pending")}async function handleLogin(e){e.preventDefault();const t=document.getElementById("loginUsername").value,r=document.getElementById("loginPassword").value;showLoading();try{const e=await apiRequest("/user/login",{method:"POST",body:JSON.stringify({login:t,password:r})});currentUser=e.login||e.Login,localStorage.setItem("swsm_user",currentUser),document.documentElement.setAttribute("data-user-logged-in","true"),localStorage.removeItem("swsm_current_server_id"),localStorage.removeItem(LS_SERVICES_PAGE_KEY),localStorage.removeItem(LS_SERVERS_PAGE_KEY),currentServerId=null,currentServerData=null,allServices=[],currentPage=1,serversCurrentPage=1,window._sessionExpiredNotified=!1,showToast("–£—Å–ø–µ—Ö","–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!"),showMainApp(),setTimeout((()=>{showServersList(),subscribeServerEvents()}),100)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}async function handleRegister(e){e.preventDefault();const t=document.getElementById("registerUsername").value.trim(),r=document.getElementById("registerPassword").value,s=document.getElementById("registerPasswordConfirm").value,n=document.getElementById("registrationKey").value.trim();if(r===s)if(t.length<4)showToast("–û—à–∏–±–∫–∞","–õ–æ–≥–∏–Ω –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 4 —Å–∏–º–≤–æ–ª–æ–≤","error");else if(r.length<5)showToast("–û—à–∏–±–∫–∞","–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–µ –º–µ–Ω–µ–µ 5 —Å–∏–º–≤–æ–ª–æ–≤","error");else{showLoading();try{await apiRequest("/user/register",{method:"POST",body:JSON.stringify({login:t,password:r,registration_key:n})});bootstrap.Modal.getInstance(document.getElementById("registerModal")).hide(),document.getElementById("registerForm").reset(),showToast("–£—Å–ø–µ—Ö","–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ! –¢–µ–ø–µ—Ä—å –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å.")}catch(e){showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}else showToast("–û—à–∏–±–∫–∞","–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç","error")}function cleanupOnLogout(){if(serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}if(serverSseReconnectTimerId){try{clearTimeout(serverSseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(serverSseReconnectTimerId),serverSseReconnectTimerId=null}if(serverEventsSource){serverEventsSource.onopen=null,serverEventsSource.onmessage=null,serverEventsSource.onerror=null;try{serverEventsSource.close()}catch(e){}serverEventsSource=null}if(resizeDebounceTimer){try{clearTimeout(resizeDebounceTimer)}catch(e){}AppTimers.timeouts.delete(resizeDebounceTimer),resizeDebounceTimer=null}stopServicePolling(),stopServerPolling(),AppTimers.clearAll()}function handleLogout(){cleanupOnLogout(),localStorage.removeItem("swsm_user"),localStorage.removeItem("swsm_current_server_id"),localStorage.removeItem(LS_SERVICES_PAGE_KEY),localStorage.removeItem(LS_SERVERS_PAGE_KEY),currentUser=null,currentServerId=null,currentServerData=null,allServices=[],currentPage=1,allServers=[],serversCurrentPage=1,window._sessionExpiredNotified=!1,document.documentElement.removeAttribute("data-user-logged-in"),showLoginPage(),showToast("–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è","–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã")}async function loadServersList(){showLoading();try{const e=await apiRequest("/user/servers");allServers=(e||[]).slice(0,CONFIG.MAX_SERVERS_CACHE);const t=await apiRequest("/user/servers/statuses");if(Array.isArray(t)){const e=new Map;t.forEach((t=>{const r=Number(t.server_id);isNaN(r)||e.set(r,t)})),allServers.forEach((t=>{const r=Number(t.id||t.server_id);if(!isNaN(r)){const s=e.get(r);s&&(t.status=s.status||"UNKNOWN")}}))}serversCurrentPage=parseInt(localStorage.getItem(LS_SERVERS_PAGE_KEY)||"1",10);const r=getPageSize(),s=Math.max(1,Math.ceil(allServers.length/r));serversCurrentPage>s&&(serversCurrentPage=s,localStorage.setItem(LS_SERVERS_PAGE_KEY,String(serversCurrentPage))),renderServersCurrentPage(),subscribeServerEvents()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–µ—Ä–≤–µ—Ä–æ–≤","error")}finally{hideLoading()}}function renderServersList(e){serversList.innerHTML="",e&&0!==e.length?e.forEach((e=>{const t=document.createElement("div");t.className="col-md-6 col-lg-4";const r=document.createElement("div");r.className="card h-100 shadow-sm service-card server-card",r.setAttribute("data-server-id",e.id);const s=document.createElement("div");s.className="card-body";const n=document.createElement("h5");n.className="card-title mb-2";const a=document.createElement("span");a.className="server-status-indicator me-2",a.setAttribute("data-server-id",e.id),updateServerStatusIndicator(a,e.status);const o=document.createElement("i");o.className="bi bi-server me-2";const i=document.createTextNode(e.name||e.address||"");n.appendChild(a),n.appendChild(o),n.appendChild(i);const c=document.createElement("p");c.className="card-text";const d=document.createElement("small");d.className="text-muted d-block",d.innerHTML='<i class="bi bi-geo-alt me-1"></i>',d.appendChild(document.createTextNode(e.address||""));const l=document.createElement("small");l.className="text-muted d-block",l.innerHTML='<i class="bi bi-hdd-network me-1"></i>';const u=document.createElement("span");u.textContent=e.status||"UNKNOWN",u.className="server-status-text",u.setAttribute("data-status",(e.status||"UNKNOWN").toUpperCase()),l.appendChild(u);const v=document.createElement("small");v.className="text-muted d-block",v.innerHTML='<i class="bi bi-person me-1"></i>',v.appendChild(document.createTextNode(e.username||""));const m=document.createElement("small");m.className="text-muted d-block",m.innerHTML='<i class="bi bi-calendar-check me-1"></i>';try{m.appendChild(document.createTextNode(new Date(e.created_at).toLocaleDateString("ru-RU")))}catch(e){m.appendChild(document.createTextNode(""))}const S=document.createElement("small");S.className="text-muted d-block",S.innerHTML='<i class="bi bi-tags me-1"></i>',S.appendChild(document.createTextNode(e.fingerprint||"")),c.appendChild(d),c.appendChild(l),c.appendChild(v),c.appendChild(m),c.appendChild(S),s.appendChild(n),s.appendChild(c);const g=document.createElement("div");g.className="card-footer";const E=document.createElement("button");E.className="btn btn-primary btn-sm w-100",E.innerHTML='<i class="bi bi-list-task me-1"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ',E.onclick=()=>showServerDetail(e.id),g.appendChild(E),r.appendChild(s),r.appendChild(g),t.appendChild(r),serversList.appendChild(t)})):serversList.innerHTML='\n            <div class="alert alert-info text-center">\n                <i class="bi bi-info-circle me-2"></i>\n                –°–µ—Ä–≤–µ—Ä—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä" –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.\n            </div>\n        '}async function handleAddServer(e){if(e.preventDefault(),!canPerformAction("addServer"))return;const t=document.getElementById("serverName").value,r=document.getElementById("serverAddress").value,s=document.getElementById("serverUsername").value,n=document.getElementById("serverPassword").value;showLoading();try{await apiRequest("/user/servers",{method:"POST",body:JSON.stringify({name:t,address:r,username:s,password:n})});bootstrap.Modal.getInstance(document.getElementById("addServerModal")).hide(),document.getElementById("addServerForm").reset(),showToast("–£—Å–ø–µ—Ö",`–°–µ—Ä–≤–µ—Ä "${t}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!`),loadServersList()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}async function loadServerDetail(e){currentServerId=e,showLoading();try{const t=await apiRequest(`/user/servers/${e}`);currentServerData=t,renderServerDetail(t),await loadServicesList(e);const r=document.getElementById("editServerBtn");r&&(r.onclick=openEditServerModalFromDetail)}catch(e){e instanceof SessionExpiredError||(showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ—Ä–≤–µ—Ä–µ","error"),showServersList())}finally{hideLoading()}}function renderServerDetail(e){document.getElementById("serverBreadcrumb").textContent=e.name||"";const t=document.getElementById("serverDetailName");if(t){t.textContent="";const r=document.createElement("span");r.id="serverDetailIndicator",r.className="server-status-indicator me-2",updateServerStatusIndicator(r,e.status||"UNKNOWN");const s=document.createElement("i");s.className="bi bi-server me-2";const n=document.createTextNode(e.name||e.address||"");t.appendChild(r),t.appendChild(s),t.appendChild(n)}const r=document.getElementById("serverDetailStatus")||document.querySelector("#serverDetailName .server-status-text");r&&(r.textContent=e.status||"‚Äî",r.setAttribute("data-status",(e.status||"UNKNOWN").toUpperCase()));const s=document.getElementById("serverDetailAddress");s&&(s.textContent=e.address||"");const n=document.getElementById("serverDetailUsername");n&&(n.textContent=e.username||"");const a=document.getElementById("serverDetailCreated");if(a)try{a.textContent=new Date(e.created_at).toLocaleDateString("ru-RU")}catch{a.textContent=""}const o=document.getElementById("serverDetailFingerprint");o&&(o.textContent=e.fingerprint||""),currentServerId=e.id||e.server_id||null}function updateServersStatus(e){if(!Array.isArray(e)||0===e.length)return;const t=new Map;e.forEach((e=>{const r=Number(e.server_id);isNaN(r)||t.set(r,e)})),Array.isArray(allServers)&&allServers.forEach((e=>{const r=Number(e.id||e.server_id);if(!isNaN(r)){const s=t.get(r);s&&(e.status=s.status||"UNKNOWN",e.updated_at=s.updated_at||e.updated_at)}}));try{document.querySelectorAll(".server-card").forEach((e=>{const r=e.getAttribute("data-server-id"),s=parseInt(r,10);if(!Number.isFinite(s))return;const n=t.get(s);if(!n)return;const a=e.querySelector(".server-status-indicator");a&&updateServerStatusIndicator(a,n.status);const o=e.querySelector(".server-status-text");o&&(o.textContent=n.status||"UNKNOWN",o.setAttribute("data-status",(n.status||"UNKNOWN").toUpperCase()))}))}catch(e){console.error("updateServersStatus: error updating list DOM",e)}try{if(null!=currentServerId){const e=Number(currentServerId);if(Number.isFinite(e)){const r=t.get(e);if(r){const e=document.getElementById("serverDetailIndicator");e&&updateServerStatusIndicator(e,r.status);const t=document.getElementById("serverDetailStatus")||document.querySelector("#serverDetailName .server-status-text");t&&(t.textContent=r.status||"‚Äî",t.setAttribute("data-status",(r.status||"UNKNOWN").toUpperCase()))}}}}catch(e){console.error("updateServersStatus: error updating detail view",e)}}async function handleDeleteServer(){if(currentServerId&&currentServerData&&confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä "${currentServerData.name}"?`)){showLoading();try{await apiRequest(`/user/servers/${currentServerId}`,{method:"DELETE"}),showToast("–£—Å–ø–µ—Ö",`–°–µ—Ä–≤–µ—Ä "${currentServerData.name}" —É–¥–∞–ª–µ–Ω`),showServersList()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}function openEditServerModalFromDetail(){if(currentServerId&&currentServerData)try{document.getElementById("editServerId").value=currentServerData.id,document.getElementById("editServerName").value=currentServerData.name||"",document.getElementById("editServerAddress").value=currentServerData.address||"",document.getElementById("editServerUsername").value=currentServerData.username||"",document.getElementById("editServerPassword").value="";new bootstrap.Modal(document.getElementById("editServerModal")).show()}catch(e){showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è","error")}else showToast("–û—à–∏–±–∫–∞","–î–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã","error")}async function handleEditServer(e){e.preventDefault();const t=document.getElementById("editServerId").value,r=document.getElementById("editServerName").value,s=document.getElementById("editServerAddress").value,n=document.getElementById("editServerUsername").value,a=document.getElementById("editServerPassword").value;showLoading();try{const e={name:r,address:s,username:n};a.trim()&&(e.password=a),await apiRequest(`/user/servers/${t}`,{method:"PATCH",body:JSON.stringify(e)});bootstrap.Modal.getInstance(document.getElementById("editServerModal")).hide(),document.getElementById("editServerForm").reset(),currentServerData.name=r,currentServerData.address=s,currentServerData.username=n,renderServerDetail(currentServerData),showToast("–£—Å–ø–µ—à–Ω–æ","–°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω!"),currentServerId===parseInt(t)&&loadServersList()}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}async function loadServicesList(e,t=!1){t||showLoading();try{const t=Date.now(),r=await apiRequest(`/user/servers/${e}/services?_t=${t}`);allServices=r.slice(0,CONFIG.MAX_SERVICES_CACHE),currentPage=parseInt(localStorage.getItem(LS_SERVICES_PAGE_KEY)||"1",10);const s=getPageSize(),n=Math.max(1,Math.ceil(allServices.length/s));currentPage>n&&(currentPage=n),localStorage.setItem(LS_SERVICES_PAGE_KEY,String(currentPage)),lastServicesUpdateAt=Date.now(),renderCurrentPage()}catch(e){throw t||e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª—É–∂–±","error"),e}finally{t||hideLoading()}}function renderServicesList(e){servicesList.innerHTML="";const t=document.getElementById("refreshFromServerBtn");if(!e||0===e.length)return servicesList.innerHTML='\n            <div class="col-12">\n                <div class="alert alert-warning text-center">\n                    <i class="bi bi-exclamation-triangle me-2"></i>\n                    –°–ø–∏—Å–æ–∫ —Å–ª—É–∂–± –ø—É—Å—Ç\n                </div>\n            </div>',void(t&&(t.style.display="none"));e.forEach((e=>{const t=document.getElementById("serviceCardTemplate").content.cloneNode(!0);t.querySelector(".service-displayed-name").textContent=e.displayed_name,t.querySelector(".service-name").textContent=e.service_name,t.querySelector(".service-status").textContent=e.status||"‚Äî",t.querySelector(".service-updated").textContent=e.updated_at?new Date(e.updated_at).toLocaleString("ru-RU"):"‚Äî";t.querySelector(".service-card").setAttribute("data-service-id",e.id);const r=t.querySelector(".service-start-btn"),s=t.querySelector(".service-stop-btn"),n=t.querySelector(".service-restart-btn"),a=t.querySelector(".service-delete-btn");r.onclick=function(){controlService(e.id,"start",e.displayed_name)},s.onclick=function(){controlService(e.id,"stop",e.displayed_name)},n.onclick=function(){controlService(e.id,"restart",e.displayed_name)},a.onclick=function(){handleDeleteService(e.id,e.displayed_name)},servicesList.appendChild(t)})),t&&(t.style.display="inline-block")}async function handleAddService(e){if(e.preventDefault(),!currentServerId)return void showToast("–û—à–∏–±–∫–∞","–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä","error");const t=document.getElementById("serviceDisplayedName").value,r=document.getElementById("serviceName").value;showLoading();try{const e=await apiRequest(`/user/servers/${currentServerId}/services`,{method:"POST",body:JSON.stringify({displayed_name:t,service_name:r})});bootstrap.Modal.getInstance(document.getElementById("addServiceModal")).hide(),document.getElementById("addServiceForm").reset(),showToast("–£—Å–ø–µ—Ö",`–°–ª—É–∂–±–∞ "${e.displayed_name}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!`),loadServicesList(currentServerId)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}async function controlService(e,t,r){if(canPerformAction(`service_${t}`)){showLoading();try{let s;switch(t){case"start":s=`/user/servers/${currentServerId}/services/${e}/start`;break;case"stop":s=`/user/servers/${currentServerId}/services/${e}/stop`;break;case"restart":s=`/user/servers/${currentServerId}/services/${e}/restart`;break;default:throw new Error("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ")}const n=await apiRequest(s,{method:"POST"}),a=await apiRequest(`/user/servers/${currentServerId}/services/${e}`),o=document.querySelector(`[data-service-id="${e}"]`);if(o){const e=o.querySelector(".service-status"),t=o.querySelector(".service-updated");e&&(e.textContent=a.status||"‚Äî"),t&&(t.textContent=a.updated_at?new Date(a.updated_at).toLocaleString("ru-RU"):"‚Äî")}const i="start"===t?"–∑–∞–ø—É—â–µ–Ω–∞":"stop"===t?"–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞":"–ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–∞";showToast("–£—Å–ø–µ—Ö",n.message||`–°–ª—É–∂–±–∞ "${r}" ${i}`)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",`–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é "${t}" –¥–ª—è —Å–ª—É–∂–±—ã "${r}"`,"error")}finally{hideLoading()}}}async function handleDeleteService(e,t){if(confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–ª—É–∂–±—É "${t}"?`)){showLoading();try{await apiRequest(`/user/servers/${currentServerId}/services/${e}`,{method:"DELETE"}),showToast("–£—Å–ø–µ—Ö",`–°–ª—É–∂–±–∞ "${t}" —É–¥–∞–ª–µ–Ω–∞`),loadServicesList(currentServerId)}catch(e){e instanceof SessionExpiredError||showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}async function handleRefreshFromServer(){if(currentServerId){showLoading();try{const e=`${API_BASE}/user/servers/${currentServerId}/services?actual=true`,t=await fetch(e,{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"}),r=t.headers.get("X-Is-Updated"),s=await t.json();allServices=s.slice(0,CONFIG.MAX_SERVICES_CACHE),currentPage=parseInt(localStorage.getItem(LS_SERVICES_PAGE_KEY)||"1",10);const n=getPageSize(),a=Math.max(1,Math.ceil(allServices.length/n));currentPage>a&&(currentPage=a),localStorage.setItem(LS_SERVICES_PAGE_KEY,String(currentPage)),lastServicesUpdateAt=Date.now(),renderCurrentPage(),"false"===r?showToast("–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ","–ü—Ä–æ–±–ª–µ–º—ã —Å–æ —Å–≤—è–∑—å—é. –ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫—ç—à–∞.","warning"):showToast("–£—Å–ø–µ—Ö","–°—Ç–∞—Ç—É—Å—ã —Å–ª—É–∂–± –æ–±–Ω–æ–≤–ª–µ–Ω—ã —Å —Å–µ—Ä–≤–µ—Ä–∞")}catch(e){showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã","error")}finally{hideLoading()}}else showToast("–û—à–∏–±–∫–∞","–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä","error")}let availableServices=[];async function loadAvailableServices(e){try{const t=await apiRequest(`/user/servers/${e}/services/available`);return availableServices=t.services||[],availableServices}catch(e){return console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–ª—É–∂–±:",e),showToast("–û—à–∏–±–∫–∞","–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–ª—É–∂–±","error"),[]}}function renderCurrentPage(){if(!allServices||0===allServices.length){renderServicesList([]);const e=document.getElementById("pageIndicator"),t=document.getElementById("prevPageBtn"),r=document.getElementById("nextPageBtn");return e&&(e.textContent="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 0 –∏–∑ 0",e.style.display="none"),t&&(t.style.display="none"),void(r&&(r.style.display="none"))}const e=getMinItemsForPagination("services"),t=document.getElementById("pageIndicator"),r=document.getElementById("prevPageBtn"),s=document.getElementById("nextPageBtn");if(!(allServices.length>e))return renderServicesList(allServices),t&&(t.style.display="none"),r&&(r.style.display="none"),s&&(s.style.display="none"),currentPage=1,void(totalPages=1);const n=getPageSize();totalPages=Math.max(1,Math.ceil(allServices.length/n)),currentPage>totalPages&&(currentPage=totalPages);const a=(currentPage-1)*n,o=a+n;renderServicesList(allServices.slice(a,o)),t&&(t.style.display="",t.textContent=`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${currentPage} –∏–∑ ${totalPages}`),r&&(r.style.display="",r.disabled=1===currentPage),s&&(s.style.display="",s.disabled=currentPage===totalPages)}function renderServersCurrentPage(){const e=document.querySelector(".servers-pagination-controls");if(!allServers||0===allServers.length){renderServersList([]);const t=document.getElementById("serversPageIndicator"),r=document.getElementById("serversPrevPageBtn"),s=document.getElementById("serversNextPageBtn");return t&&(t.textContent="–°—Ç—Ä–∞–Ω–∏—Ü–∞ 0 –∏–∑ 0",t.style.display="none"),r&&(r.style.display="none"),s&&(s.style.display="none"),void(e&&(e.style.display="none"))}const t=getMinItemsForPagination("servers"),r=document.getElementById("serversPageIndicator"),s=document.getElementById("serversPrevPageBtn"),n=document.getElementById("serversNextPageBtn"),a=allServers.length>t;if(!a)return renderServersList(allServers),r&&(r.style.display="none"),s&&(s.style.display="none"),n&&(n.style.display="none"),e&&(e.style.display="none"),void(serversCurrentPage=1);const o=getPageSize();serversTotalPages=Math.max(1,Math.ceil(allServers.length/o)),serversCurrentPage>serversTotalPages&&(serversCurrentPage=serversTotalPages);const i=(serversCurrentPage-1)*o,c=i+o;renderServersList(allServers.slice(i,c)),r&&(r.style.display="",r.textContent=`–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${serversCurrentPage} –∏–∑ ${serversTotalPages}`),s&&(s.style.display="",s.disabled=1===serversCurrentPage),n&&(n.style.display="",n.disabled=serversCurrentPage===serversTotalPages),e&&(e.style.display=a?"flex":"none")}function setupEventListeners(){const e=document.getElementById("loginForm");e&&e.addEventListener("submit",handleLogin);const t=document.getElementById("registerForm");t&&t.addEventListener("submit",handleRegister);const r=document.getElementById("addServerForm");r&&r.addEventListener("submit",handleAddServer);const s=document.getElementById("editServerForm");s&&s.addEventListener("submit",handleEditServer);const n=document.getElementById("addServiceForm");n&&n.addEventListener("submit",handleAddService);const a=document.getElementById("refreshFromServerBtn");a&&a.addEventListener("click",handleRefreshFromServer);const o=document.getElementById("logoutBtn");o&&o.addEventListener("click",handleLogout);const i=document.getElementById("deleteServerBtn");i&&i.addEventListener("click",handleDeleteServer),document.querySelectorAll(".modal").forEach((e=>{e.addEventListener("hidden.bs.modal",(function(){document.querySelectorAll(".modal-backdrop").forEach((e=>e.remove())),document.body.classList.remove("modal-open","overflow"),document.body.style.overflow=""}))}));const c=document.getElementById("prevPageBtn"),d=document.getElementById("nextPageBtn");c&&c.addEventListener("click",(()=>{currentPage>1&&(currentPage--,localStorage.setItem(LS_SERVICES_PAGE_KEY,String(currentPage)),renderCurrentPage())})),d&&d.addEventListener("click",(()=>{currentPage<totalPages&&(currentPage++,localStorage.setItem(LS_SERVICES_PAGE_KEY,String(currentPage)),renderCurrentPage())}));const l=document.getElementById("serversPrevPageBtn"),u=document.getElementById("serversNextPageBtn");l&&l.addEventListener("click",(()=>{serversCurrentPage>1&&(serversCurrentPage--,localStorage.setItem(LS_SERVERS_PAGE_KEY,String(serversCurrentPage)),renderServersCurrentPage())})),u&&u.addEventListener("click",(()=>{serversCurrentPage<serversTotalPages&&(serversCurrentPage++,localStorage.setItem(LS_SERVERS_PAGE_KEY,String(serversCurrentPage)),renderServersCurrentPage())}))}document.getElementById("addServiceModal").addEventListener("show.bs.modal",(async()=>{if(!currentServerId)return;const e=document.getElementById("serviceSelect");e.innerHTML='<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±...</option>';const t=await loadAvailableServices(currentServerId);e.innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É --</option>',t.forEach((t=>{const r=document.createElement("option");r.value=t,r.textContent=t,e.appendChild(r)}))})),document.getElementById("serviceSelect").addEventListener("change",(e=>{const t=e.target.value;document.getElementById("serviceDisplayName").value=t})),document.getElementById("addServiceModal").addEventListener("hide.bs.modal",(()=>{document.getElementById("addServiceForm").reset(),document.getElementById("serviceSelect").innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É --</option>',document.getElementById("serviceDisplayName").value=""})),document.getElementById("addServiceModal").addEventListener("show.bs.modal",(async()=>{if(!currentServerId)return;const e=document.getElementById("serviceSelect");e.disabled=!0,e.innerHTML='<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ª—É–∂–±...</option>';const t=await loadAvailableServices(currentServerId);e.disabled=!1,e.innerHTML='<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É --</option>',t.forEach((t=>{const r=document.createElement("option");r.value=t,r.textContent=t,e.appendChild(r)}))})),document.getElementById("serviceSelect").addEventListener("change",(e=>{const t=e.target.value;document.getElementById("serviceDisplayName").value=t})),document.getElementById("addServiceBtn").addEventListener("click",(async()=>{const e=document.getElementById("serviceSelect").value,t=document.getElementById("serviceDisplayName").value;if(e){if(canPerformAction("addService")){showLoading();try{await apiRequest(`/user/servers/${currentServerId}/services`,{method:"POST",body:JSON.stringify({service_name:e,displayed_name:t||e})}),showToast("–£—Å–ø–µ—Ö","–°–ª—É–∂–±–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞");bootstrap.Modal.getInstance(document.getElementById("addServiceModal")).hide(),loadServicesList(currentServerId)}catch(e){showToast("–û—à–∏–±–∫–∞",e.message,"error")}finally{hideLoading()}}}else showToast("–û—à–∏–±–∫–∞","–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª—É–∂–±—É","error")})),document.addEventListener("visibilitychange",(()=>{if(document.hidden){if(handlePageBackground(),serverEventsSource){try{serverEventsSource.close()}catch(e){}serverEventsSource=null}}else handlePageResume(),subscribeServerEvents()}),!1);let isPageVisible=!0;function handlePageBackground(){if(serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null,sseConnectionStatus="closed",sseReconnectAttempts=0}if(sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(sseReconnectTimerId),sseReconnectTimerId=null}if(stopServicePolling(),stopServerPolling(),serverEventsSource){try{serverEventsSource.close()}catch(e){}serverEventsSource=null}if(serverSseReconnectTimerId){try{clearTimeout(serverSseReconnectTimerId)}catch(e){}AppTimers.timeouts.delete(serverSseReconnectTimerId),serverSseReconnectTimerId=null}}const MIN_RESUME_INTERVAL=1e3;let lastResumeTime=0;function handlePageResume(){const e=Date.now();e-lastResumeTime<300||(lastResumeTime=e,currentUser&&currentServerId&&!document.hidden&&(switchConnectionsMode(),isMobileDevice()?(loadServicesList(currentServerId,!0).catch((e=>{console.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:",e)})),servicePollingInterval||startServicePolling(currentServerId)):serviceEventsSource&&serviceEventsSource.readyState!==EventSource.CLOSED||subscribeServiceEvents(currentServerId),subscribeServerEvents()))}function showLoginPage(){if(loginPage&&(loginPage.classList.remove("hidden"),loginPage.style.display=""),mainApp&&(mainApp.classList.add("hidden"),mainApp.style.display="none"),document.documentElement.removeAttribute("data-user-logged-in"),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,window._sessionExpiredNotified=!1,serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}stopServicePolling()}function showMainApp(){loginPage&&(loginPage.classList.add("hidden"),loginPage.style.display="none"),mainApp&&(mainApp.classList.remove("hidden"),mainApp.style.display=""),currentUser&&currentUserSpan&&(currentUserSpan.textContent=currentUser)}function showServersList(){serversListView.classList.remove("hidden"),serverDetailView.classList.add("hidden"),localStorage.removeItem("swsm_current_server_id"),currentServerId=null,currentServerData=null,allServices=[],currentPage=1,totalPages=1,sseReconnectAttempts=0,serversCurrentPage=1,serversTotalPages=1,stopServicePolling(),stopServerPolling(),loadServersList(),subscribeServerEvents()}function showServerDetail(e){serversListView.classList.add("hidden"),serverDetailView.classList.remove("hidden"),currentServerId=e,localStorage.setItem("swsm_current_server_id",e),subscribeServerEvents();let t=null;if(Array.isArray(allServers)&&(t=allServers.find((t=>Number(t.id||t.server_id)===Number(e)))),t){currentServerData=t,renderServerDetail(t),loadServicesList(e,!0).catch((t=>{console.warn("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª—É–∂–± –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–µ—Ç–∞–ª–∫–∏ (silent):",t),startServicePolling(e)}));let r=0;const s=++r;(async()=>{try{const n=await apiRequest(`/user/servers/${e}`);s===r&&currentServerId===e&&(n.status=t.status||n.status,currentServerData=Object.assign({},t,n),renderServerDetail(currentServerData))}catch(e){console.debug("–§–æ–Ω–æ–≤—ã–π –∞–ø–¥–µ–π—Ç –¥–µ—Ç–∞–ª—å–∫–∏ –Ω–µ —É–¥–∞–ª—Å—è:",e)}})()}else loadServerDetail(e);subscribeServiceEvents(e)}function showLoading(){loadingSpinner&&(loadingSpinner.style.display="block")}function hideLoading(){loadingSpinner&&(loadingSpinner.style.display="none")}function cleanupApp(){cleanupOnLogout(),allServers=[],allServices=[],toastHistory=[],REQUEST_RATE_LIMIT.clear(),AppTimers.clearAll(),window.removeEventListener("resize",onWindowResize),document.removeEventListener("visibilitychange",handlePageBackground)}window.addEventListener("beforeunload",(()=>{if(AppTimers.clearAll(),serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}cleanupOnLogout()})),window.addEventListener("beforeunload",(()=>{if(AppTimers.clearAll(),serviceEventsSource){try{serviceEventsSource.close()}catch(e){}serviceEventsSource=null}if(serverEventsSource){try{serverEventsSource.close()}catch(e){}serverEventsSource=null}if(resizeDebounceTimer){try{clearTimeout(resizeDebounceTimer)}catch(e){}resizeDebounceTimer=null}if(sseReconnectTimerId){try{clearTimeout(sseReconnectTimerId)}catch(e){}sseReconnectTimerId=null}if(serverSseReconnectTimerId){try{clearTimeout(serverSseReconnectTimerId)}catch(e){}serverSseReconnectTimerId=null}}));